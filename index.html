<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abyssal Alchemy - Water Sort Rogue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #020617;
            --tube-border: #334155;
            --tube-bg: rgba(15, 23, 42, 0.4);
            --pour-speed: 0.3s;
            --segment-height: 40px; /* JSã§å‹•çš„ã«å¤‰æ›´ã•ã‚Œã¾ã™ */
            --tube-height: 220px;   /* JSã§å‹•çš„ã«å¤‰æ›´ã•ã‚Œã¾ã™ */
            --primary-glow: #38bdf8;
            --rarity-common: #94a3b8;
            --rarity-rare: #3b82f6;
            --rarity-epic: #a855f7;
        }

        body {
            background: radial-gradient(circle at 50% 0%, #0f172a 0%, #020617 100%);
            color: white;
            font-family: 'Inter', system-ui, sans-serif;
            touch-action: manipulation;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            user-select: none;
            -webkit-user-select: none;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* ãƒãƒ¥ãƒ¼ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tube {
            width: clamp(40px, 10vw, 56px);
            height: var(--tube-height);
            border: 3px solid var(--tube-border);
            border-top: 2px solid rgba(255,255,255,0.15);
            border-bottom-left-radius: 28px;
            border-bottom-right-radius: 28px;
            position: relative;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s ease, border-color 0.3s ease;
            background: var(--tube-bg);
            margin: 6px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’å°‘ã—è©°ã‚ã‚‹ */
            z-index: 10;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            box-shadow: inset 2px 0 4px rgba(255,255,255,0.05), inset -2px 0 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .tube.selected {
            transform: translateY(-15px) scale(1.05);
            border-color: var(--primary-glow);
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.25);
            z-index: 20;
        }
        
        .tube.target-mode {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
            animation: pulse-purple 1.5s infinite;
        }

        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 30px rgba(168, 85, 247, 0.7); }
        }

        .tube-focused {
            border-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.3); /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å°‘ã—å¼·èª¿ */
        }

        /* è©°ã¿è­¦å‘Š */
        .deadlock-glow {
            box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.5) !important;
            border-color: rgba(244, 63, 94, 0.8) !important;
        }

        .water-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column-reverse;
            padding: 0;
            gap: 0;
            pointer-events: none;
            width: 100%;
        }

        .water-segment {
            width: 100%;
            height: var(--segment-height);
            position: relative;
            transition: height 0.3s ease, opacity 0.3s ease;
        }

        .water-segment::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.1) 0%, 
                rgba(255,255,255,0) 20%, 
                rgba(0,0,0,0.1) 50%, 
                rgba(255,255,255,0) 80%, 
                rgba(255,255,255,0.15) 100%);
            opacity: 0.6;
        }

        .water-segment:last-child {
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        .water-segment:last-child::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255,255,255,0.4);
            filter: blur(2px);
            border-radius: 50%;
            transform: scaleX(0.9);
        }
        
        /* è’¸ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        @keyframes evaporate {
            0% { transform: scale(1); opacity: 1; filter: brightness(1); }
            50% { filter: brightness(2); background-color: white; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .evaporating .water-segment {
            animation: evaporate 0.6s forwards;
        }

        /* è¨€èªãƒœã‚¿ãƒ³ */
        .lang-btn{
            padding: 6px 10px;
            font-weight: 800;
            font-size: 12px;
            border-radius: 12px;
            opacity: 0.55;
            transition: all .2s;
        }
        .lang-btn.active{ opacity: 1; background: rgba(56,189,248,0.15); border: 1px solid rgba(56,189,248,0.35); }

        /* å¤‰ç•°ã‚«ãƒ¼ãƒ‰ */
        .perk-card {
            transition: all 0.25s ease;
            border: 1px solid rgba(255,255,255,0.06);
            position: relative;
            overflow: hidden;
        }
        .perk-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border-color: rgba(56,189,248,0.35);
        }

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ */
        .rarity-common{ border-left: 3px solid var(--rarity-common); }
        .rarity-rare{ border-left: 3px solid var(--rarity-rare); }
        .rarity-epic{ border-left: 3px solid var(--rarity-epic); }
        
        /* ã‚¹ã‚­ãƒ«ãƒœã‚¿ãƒ³ & ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .skill-btn {
            position: relative;
            transition: all 0.2s;
            filter: grayscale(0.8);
            opacity: 0.7;
        }
        .skill-btn:not(:disabled):hover {
            filter: grayscale(0);
            opacity: 1;
            transform: translateY(-2px);
            z-index: 50; /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºæ™‚ã«æ‰‹å‰ã« */
        }
        .skill-btn.active {
            filter: grayscale(0);
            opacity: 1;
            border-color: var(--primary-glow);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
            background: rgba(56, 189, 248, 0.2);
        }
        .skill-btn.active-mode {
            filter: grayscale(0);
            opacity: 1;
            border-color: #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
            background: rgba(168, 85, 247, 0.2);
            animation: pulse-btn 1.5s infinite;
        }
        @keyframes pulse-btn {
            0% { box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.8); }
            100% { box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
        .skill-tooltip {
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(2, 6, 23, 0.95);
            border: 1px solid rgba(56, 189, 248, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            width: max-content;
            max-width: 220px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }
        .skill-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(56, 189, 248, 0.3) transparent transparent transparent;
        }
        .skill-btn:hover .skill-tooltip {
            opacity: 1;
            visibility: visible;
            bottom: 125%;
        }

        /* UNDOãƒœã‚¿ãƒ³ */
        #btn-undo {
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            transition: all 0.2s;
        }
        #btn-undo:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }
        #btn-undo:active {
            transform: scale(0.95);
        }

        /* è­¦å‘ŠãƒãƒŠãƒ¼ */
        #alert-banner {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(244, 63, 94, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        #toast-container {
            pointer-events: none;
        }
        .toast-msg {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(56, 189, 248, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            animation: toast-in 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(4px);
        }
        .toast-msg.fade-out {
            animation: toast-out 0.3s forwards;
        }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(-20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toast-out {
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* æµ®éŠ */
        .floating{
            animation: floaty 3.2s ease-in-out infinite;
        }
        @keyframes floaty{
            0%,100%{ transform: translateY(0); }
            50%{ transform: translateY(-10px); }
        }

        /* ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ç”¨ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚¿ã‚¤ãƒ« */
        #tubes-container {
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-origin: center center;
            /* å¿…è¦ãªã‚‰ã“ã“ã«max-widthãªã©ã®åˆ¶é™ã‚’è¿½åŠ  */
        }

        /* ãƒ†ã‚¹ãƒˆè¡¨ç¤º */
        #dev-tests {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 999;
            font-family: ui-monospace, Menlo, Consolas, monospace;
            font-size: 11px;
            color: rgba(255,255,255,0.75);
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 8px 10px;
            border-radius: 8px;
            max-width: min(560px, 92vw);
            white-space: pre-wrap;
            display:none;
        }
    </style>
</head>
<body>
    
    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[200] flex flex-col gap-2 w-full max-w-sm px-4"></div>

    <div id="game-container" class="flex flex-col items-center justify-between h-screen w-screen p-2 md:p-4 overflow-hidden relative">
        <div id="alert-banner">NO MOVES LEFT</div>

        <!-- ãƒˆãƒƒãƒ—HUD -->
        <div id="top-hud" class="w-full max-w-5xl glass-panel p-3 md:p-4 flex items-center justify-between z-20 shrink-0 mb-2">
            <div class="flex items-center gap-4">
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]" id="ui-subtitle">éŒ¬é‡‘è¡“ã®æ·±æ·µ</div>
                    <div class="text-xl md:text-2xl font-black tracking-tight leading-none bg-gradient-to-br from-white to-slate-400 bg-clip-text text-transparent" id="ui-title">Abyssal Alchemy</div>
                </div>
                <div class="hidden md:flex items-center gap-3 ml-4">
                    <span class="px-4 py-2 rounded-xl glass-panel text-xl font-bold border border-white/5" id="ui-floor">FLOOR 1</span>
                    <span class="px-4 py-2 rounded-xl glass-panel text-xl font-bold text-sky-300 border border-white/5" id="ui-essence">0 âœ¨</span>
                    <span class="px-4 py-2 rounded-xl glass-panel text-xl font-bold text-rose-300 border border-white/5" id="ui-hp">HP 3</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button id="btn-help" class="w-10 h-10 md:w-auto md:h-auto md:px-4 md:py-2 flex items-center justify-center glass-panel font-bold text-xs uppercase tracking-widest hover:bg-white/5 active:scale-95 transition-all">
                    <span class="md:hidden">?</span><span class="hidden md:inline">Help</span>
                </button>
                <button id="btn-settings" class="w-10 h-10 md:w-auto md:h-auto md:px-4 md:py-2 flex items-center justify-center glass-panel font-bold text-xs uppercase tracking-widest hover:bg-white/5 active:scale-95 transition-all">âš™</button>
            </div>
        </div>

        <!-- ç›®æ¨™/åœ§åŠ› è¡Œ -->
        <div id="status-bar" class="w-full max-w-5xl flex gap-2 shrink-0 z-20 mb-2">
            <div class="flex-1 glass-panel px-4 py-2 border-l-4 border-l-sky-500/50">
                <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]" id="ui-goal-title">GOAL</div>
                <div class="text-sm font-black tracking-tight text-white" id="ui-goal">â€”</div>
                <div class="text-[10px] text-slate-500 mt-1" id="ui-goal-sub">â€”</div>
            </div>
            <div class="w-[180px] md:w-[220px] glass-panel px-4 py-2 border-l-4 border-l-rose-500/50">
                <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]">PRESSURE</div>
                <div class="flex items-center gap-2 mt-1">
                    <div class="flex-1 h-2 rounded-full bg-slate-800/80 overflow-hidden relative border border-white/5">
                        <div id="ui-pressure-bar" class="h-full rounded-full bg-gradient-to-r from-sky-400 via-purple-400 to-rose-500 transition-all duration-300" style="width:0%"></div>
                    </div>
                    <div class="text-xs font-black w-5 text-right" id="ui-pressure">0</div>
                </div>
                <div class="text-[10px] text-slate-500 mt-1 text-right" id="ui-pressure-sub">â€”</div>
            </div>
        </div>

        <!-- ç›¤é¢ã‚¨ãƒªã‚¢ -->
        <!-- overflow-hidden ã‚’è¿½åŠ ã—ã€å†…éƒ¨ã®tubes-containerãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«ã™ã‚‹ -->
        <div id="board-area" class="flex-1 w-full flex items-center justify-center relative z-10 overflow-hidden my-2">
            <div id="tubes-container" class="flex flex-wrap items-center justify-center content-center max-w-5xl"></div>
        </div>
        
        <!-- ã‚¹ã‚­ãƒ«ãƒãƒ¼ -->
        <div id="skills-container" class="w-full max-w-lg flex justify-center gap-3 z-20 mb-2 min-h-[50px] shrink-0">
            <!-- JSã§ãƒœã‚¿ãƒ³ç”Ÿæˆ -->
        </div>

        <!-- ä¸‹HUD -->
        <div id="bottom-hud" class="w-full max-w-5xl glass-panel p-3 md:p-4 shrink-0 z-20 mb-safe">
            <div class="md:hidden flex justify-between mb-3 px-1">
                 <span class="text-lg font-bold text-sky-300" id="ui-essence-mobile">0 âœ¨</span>
                 <span class="text-lg font-bold text-rose-300" id="ui-hp-mobile">HP 3</span>
            </div>
            <div class="flex items-center justify-between gap-3 relative">
                <div class="flex items-center gap-2 md:gap-3 flex-wrap">
                    <span class="px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest bg-black/20" id="ui-turn">TURN 0</span>
                    <span class="px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest bg-black/20" id="ui-secondary">BONUS â€”</span>
                    <span class="px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest text-sky-300 bg-black/20 hidden sm:block" id="ui-perks">PERKS 0</span>
                </div>
                
                <!-- ãƒ’ãƒ³ãƒˆè¦ç´ å‰Šé™¤ -->

                <!-- UNDOãƒœã‚¿ãƒ³ -->
                <button id="btn-undo" class="px-4 py-2 rounded-xl font-bold text-xs uppercase tracking-widest text-slate-300 flex items-center gap-2">
                    <span>â†º</span> UNDO (5âœ¨)
                </button>
            </div>
        </div>

    </div>

    <!-- ç”»é¢ï¼šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå®Œæˆ2æŠï¼‰ -->
    <div id="event-screen" class="fixed inset-0 z-[140] bg-slate-950/85 backdrop-blur-sm hidden items-center justify-center p-6 transition-opacity">
        <div class="glass-panel w-full max-w-2xl p-6 border border-sky-500/20 shadow-2xl shadow-sky-900/20">
            <div class="flex items-end justify-between gap-4">
                <div>
                    <div class="text-[10px] text-sky-400 uppercase tracking-[0.35em] font-bold" id="event-kicker">EVENT</div>
                    <div class="text-3xl font-black tracking-tight text-white mt-1" id="event-title">â€”</div>
                    <div class="text-slate-300 text-sm mt-3 whitespace-pre-line leading-relaxed" id="event-desc">â€”</div>
                </div>
                <div class="text-right shrink-0">
                    <div class="px-3 py-1 bg-rose-500/10 border border-rose-500/30 rounded text-[10px] text-rose-300 uppercase tracking-[0.2em]">Unavoidable</div>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mt-8" id="event-choices"></div>
        </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-950 p-8">
        <div class="absolute top-8 right-8 flex gap-2 glass-panel p-1 z-50">
            <button onclick="setLang('en')" id="lang-en" class="lang-btn">EN</button>
            <button onclick="setLang('ja')" id="lang-ja" class="lang-btn active">JP</button>
        </div>

        <div class="text-center mb-16 floating relative">
            <div class="absolute inset-0 bg-sky-500/20 blur-[100px] rounded-full"></div>
            <h1 class="relative text-5xl md:text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-sky-300 via-sky-500 to-indigo-600 drop-shadow-2xl leading-tight">ABYSSAL<br>ALCHEMY</h1>
            <p id="start-subtitle" class="relative text-sky-200/60 font-medium tracking-[0.5em] uppercase text-xs mt-4">éŒ¬é‡‘è¡“ã®æ·±æ·µ</p>
        </div>
        <button id="start-run-btn" class="w-full max-w-xs py-5 bg-sky-600 rounded-2xl font-black text-white uppercase tracking-widest shadow-2xl shadow-sky-500/20 hover:bg-sky-500 hover:shadow-sky-500/40 hover:-translate-y-1 transition-all active:scale-95 active:translate-y-0">æ¢ç´¢ã‚’é–‹å§‹</button>
        <p class="text-slate-600 text-[10px] mt-8 tracking-widest uppercase">Ver 1.9.3 No Hint</p>
    </div>

    <!-- å¤‰ç•°é¸æŠ & ã‚·ãƒ§ãƒƒãƒ—ç”»é¢ (Layout Revised: 1-screen fit) -->
    <div id="perk-screen" class="fixed inset-0 z-[150] bg-slate-950 flex flex-col items-center justify-center p-4 md:p-8 hidden">
        <div class="w-full max-w-6xl h-full max-h-full flex flex-col glass-panel p-0 overflow-hidden relative border border-white/10 shadow-2xl shadow-black/80">
            
            <!-- Header -->
            <div class="flex justify-between items-center p-4 md:p-6 border-b border-white/5 shrink-0 bg-slate-900/40">
                <div>
                    <h2 id="perk-title" class="text-xl md:text-3xl font-black text-white italic uppercase leading-none">å¤‰ç•°ã®å…†ã—</h2>
                    <p id="perk-subtitle" class="text-slate-400 text-[10px] md:text-xs mt-1 uppercase tracking-widest">ç„¡æ–™ã®å¼·åŒ–ã‚’1ã¤é¸æŠ</p>
                </div>
                <div class="text-right flex flex-col items-end gap-2">
                    <button id="reroll-btn" class="px-3 py-1 glass-panel border border-white/5 text-[10px] font-black uppercase tracking-widest hover:bg-white/5 active:scale-95 transition-all hidden">Reroll (-5âœ¨)</button>
                    <!-- ã‚¹ãƒãƒ›ç”¨ã®Essenceè¡¨ç¤ºã¯ã‚·ãƒ§ãƒƒãƒ—å†…ã«çµ±åˆã™ã‚‹ã“ã¨ã‚‚æ¤œè¨ã—ãŸãŒã€ã“ã“ãŒè¦‹ã‚„ã™ã„ -->
                </div>
            </div>

            <!-- Main Content (Split Layout) -->
            <div class="flex-1 flex flex-col md:flex-row min-h-0 overflow-hidden">
                
                <!-- Left: Perks -->
                <div class="flex-1 flex flex-col p-4 md:p-6 overflow-y-auto border-b md:border-b-0 md:border-r border-white/5 bg-slate-900/20">
                    <div class="text-sm font-bold mb-3 text-sky-300 uppercase tracking-widest flex items-center gap-2">
                        <span>ğŸ§¬ Mutations</span>
                        <span class="text-[10px] text-slate-500 font-normal normal-case">Pick One</span>
                    </div>
                    <div class="grid gap-3" id="perk-cards">
                        <!-- Perks injected here -->
                    </div>
                </div>

                <!-- Right: Shop -->
                <div class="flex-1 flex flex-col p-4 md:p-6 overflow-y-auto">
                    <div class="flex justify-between items-center mb-3">
                        <div class="text-sm font-bold text-yellow-500 uppercase tracking-widest flex items-center gap-2">
                            <span>â—ˆ Shop</span>
                        </div>
                        <div class="text-[10px] font-bold text-sky-400 bg-sky-900/30 px-2 py-1 rounded border border-sky-500/20" id="perk-essence">Essence: 0 âœ¨</div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-3" id="shop-cards">
                        <!-- Shop Items injected here -->
                    </div>

                    <div class="mt-auto pt-6 flex justify-center">
                        <button id="continue-btn" class="w-full py-3 bg-indigo-600 rounded-xl font-black text-white text-sm uppercase tracking-widest shadow-lg shadow-indigo-900/40 hover:bg-indigo-500 transition-all active:scale-95">Next Floor</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Help -->
    <div id="help-screen" class="fixed inset-0 z-[160] bg-slate-950/90 backdrop-blur hidden items-center justify-center p-6">
        <div class="glass-panel w-full max-w-2xl p-8 border border-white/10">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]">HELP</div>
                    <div class="text-3xl font-black tracking-tight">Guide</div>
                </div>
                <button id="help-close" class="px-4 py-2 glass-panel font-black text-xs uppercase tracking-widest hover:bg-white/10 active:scale-95 transition-colors">Close</button>
            </div>
            <div class="text-slate-300 text-sm leading-loose whitespace-pre-line font-medium" id="help-text"></div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settings-screen" class="fixed inset-0 z-[160] bg-slate-950/90 backdrop-blur hidden items-center justify-center p-6">
        <div class="glass-panel w-full max-w-xl p-8 border border-white/10">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]">SETTINGS</div>
                    <div class="text-3xl font-black tracking-tight">Options</div>
                </div>
                <button id="settings-close" class="px-4 py-2 glass-panel font-black text-xs uppercase tracking-widest hover:bg-white/10 active:scale-95 transition-colors">Close</button>
            </div>
            <div class="mt-5 grid gap-4">
                <label class="glass-panel p-4 flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors">
                    <span class="text-sm font-black uppercase tracking-widest">Show Debug Info</span>
                    <input type="checkbox" id="toggle-tests" class="scale-125 accent-sky-500" />
                </label>
            </div>
        </div>
    </div>

    <div id="dev-tests"></div>

    <script>
        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function clamp(val, min, max){ return Math.min(Math.max(val, min), max); }
        function randInt(n){ return Math.floor(Math.random()*n); }
        function pick(arr){ return arr[randInt(arr.length)]; }
        function deepCopy(x){ return JSON.parse(JSON.stringify(x)); }
        function ui(id){ return document.getElementById(id); }
        // å®‰å…¨ãªãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
        function setText(id, text){
            const el = document.getElementById(id);
            if(el) el.textContent = text;
        }

        // --- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ ---
        function showToast(msg, color='sky'){
            const container = ui('toast-container');
            const el = document.createElement('div');
            el.className = `toast-msg text-${color}-300 border-${color}-500/30`;
            el.innerHTML = `<span>â—ˆ</span> ${msg}`;
            container.appendChild(el);
            setTimeout(() => {
                el.classList.add('fade-out');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ ---
        const translations = {
            en: {
                subtitle: "Abyssal Alchemy",
                startBtn: "Begin Descent",
                vitality: "HP",
                floor: "FLOOR",
                essence: "Essence",
                turn: "TURN",
                secondary: "BONUS",
                perks: "PERKS",
                hint: "Select a tube to pour",
                goalTitle: "GOAL",
                pressureTitle: "PRESSURE",
                eventKicker: "EVENT",
                unavoid: "Unavoidable",
                helpTitle: "How to play",
                helpText: [
                    "â€¢ Pour water: Click a tube, then click another to pour.",
                    "â€¢ Obsidian (Black Ink): Match 4 to evaporate them and clear the tube!",
                    "â€¢ Pressure: Rises with every move. If it fills, you take 1 Damage.",
                    "â€¢ Survival: No Move limit. Manage your HP and Pressure to survive.",
                    "â€¢ Artifacts: Buy skills in the shop. Use them from the bottom bar.",
                    "â€¢ Undo: Use the button below (Costs 5 Essence).",
                ].join("\n"),
                helpClose: "Close",
                settings: "Settings",
                continue: "Continue",
                shopTitle: "Shop",
                shopSub: "Trade Essence for survival",
                gameOver: "Consumed",
                gameOverSub: "The abyss claims another soul...",
                victory: "Mutation",
                victorySub: "Select a mutation to evolve",
            },
            ja: {
                subtitle: "éŒ¬é‡‘è¡“ã®æ·±æ·µ",
                startBtn: "æ¢ç´¢ã‚’é–‹å§‹",
                vitality: "HP",
                floor: "éšå±¤",
                essence: "ã‚¨ãƒƒã‚»ãƒ³ã‚¹",
                turn: "çµŒéã‚¿ãƒ¼ãƒ³",
                secondary: "å‰¯ç›®æ¨™",
                perks: "å¤‰ç•°",
                hint: "ãƒãƒ¥ãƒ¼ãƒ–ã‚’é¸æŠã—ã¦æ³¨ã",
                goalTitle: "ç›®æ¨™",
                pressureTitle: "åœ§åŠ›",
                eventKicker: "å¤‰è³ª",
                unavoid: "ä¸å¯é¿",
                helpTitle: "éŠã³æ–¹",
                helpText: [
                    "ãƒ»æ³¨ãï¼šãƒãƒ¥ãƒ¼ãƒ–ã‚’é¸æŠã—ã€åˆ¥ã®ãƒãƒ¥ãƒ¼ãƒ–ã¸æ³¨ãã¾ã™",
                    "ãƒ»é»’ã‚¤ãƒ³ã‚¯ï¼š4ã¤æƒãˆã‚‹ã¨è’¸ç™ºã—ã¦æ¶ˆãˆã€ç©ºãç“¶ã«ãªã‚Šã¾ã™ã€‚",
                    "ãƒ»åœ§åŠ›ï¼š1æ‰‹ã”ã¨ã«ä¸Šæ˜‡ã—ã¾ã™ã€‚æœ€å¤§ã«ãªã‚‹ã¨HPãŒ1æ¸›ã‚Šã¾ã™ã€‚",
                    "ãƒ»ç”Ÿå­˜ï¼šæ‰‹æ•°åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚HPãŒå°½ããªã„é™ã‚Šæ¢ç´¢ã‚’ç¶šã‘ã‚‰ã‚Œã¾ã™ã€‚",
                    "ãƒ»é“å…·ã¨ç§˜è¡“ï¼šã‚·ãƒ§ãƒƒãƒ—ã§ã‚¹ã‚­ãƒ«ã‚’è³¼å…¥ã—ã€ç”»é¢ä¸‹éƒ¨ã‹ã‚‰ä½¿ç”¨ã—ã¾ã™",
                    "ãƒ»ã‚„ã‚Šç›´ã—ï¼šå³ä¸‹ã®UNDOãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆæ¶ˆè²»ï¼š5ã‚¨ãƒƒã‚»ãƒ³ã‚¹ï¼‰",
                ].join("\n"),
                helpClose: "é–‰ã˜ã‚‹",
                settings: "è¨­å®š",
                continue: "æ¬¡ã¸é€²ã‚€",
                shopTitle: "ã‚·ãƒ§ãƒƒãƒ—",
                shopSub: "ã‚¨ãƒƒã‚»ãƒ³ã‚¹ã‚’æ¶ˆè²»ã—ã¦å®‰å®šã‚’å¾—ã‚‹",
                gameOver: "å¥ˆè½ã«å‘‘ã¾ã‚ŒãŸ",
                gameOverSub: "æ·±æ·µã¯ã¾ãŸä¸€ã¤é­‚ã‚’å–°ã‚‰ã£ãŸ...",
                victory: "å¤‰ç•°ã®å…†ã—",
                victorySub: "åŠ›ã‚’é¸ã‚“ã§é€²åŒ–ã™ã‚‹",
            }
        };

        let currentLang = 'ja';

        function setLang(lang){
            currentLang = lang;
            document.getElementById('lang-en').classList.toggle('active', lang==='en');
            document.getElementById('lang-ja').classList.toggle('active', lang==='ja');
            applyLang();
            renderHUD();
        }

        function t(key){
            return translations[currentLang]?.[key] ?? translations.en[key] ?? key;
        }

        function applyLang(){
            setText('start-subtitle', t('subtitle'));
            setText('start-run-btn', t('startBtn'));
            setText('ui-subtitle', t('subtitle'));
            setText('ui-title', translations.en.subtitle);
            // setText('ui-hint', t('hint')); // Removed
            setText('ui-goal-title', t('goalTitle'));
            setText('help-text', t('helpText'));
            setText('help-close', t('helpClose'));
        }

        // --- ã‚²ãƒ¼ãƒ å®šç¾© ---
        const COLOR_POOL = [
            { key: 'R', name:{en:'Crimson', ja:'ç´…'}, hex:'#dc2626' }, // Rose-500 -> Red-600
            { key: 'B', name:{en:'Azure', ja:'è’¼'}, hex:'#3b82f6' },
            { key: 'Y', name:{en:'Amber', ja:'ç¥ç€'}, hex:'#fbbf24' },
            { key: 'W', name:{en:'Ivory', ja:'è±¡ç‰™'}, hex:'#e2e8f0' },
            { key: 'K', name:{en:'Obsidian', ja:'é»’'}, hex:'#0f172a' },
            { key: 'G', name:{en:'Emerald', ja:'ç¿ '}, hex:'#22c55e' }, // Emerald-500 -> Green-500
            { key: 'P', name:{en:'Amethyst', ja:'ç´«'}, hex:'#a855f7' }, 
            { key: 'O', name:{en:'Orange', ja:'æ©™'}, hex:'#f97316' }, 
            { key: 'T', name:{en:'Teal', ja:'é’ç·‘'}, hex:'#06b6d4' }, // Teal-500 -> Cyan-500
            { key: 'M', name:{en:'Pink', ja:'æ¡ƒ'}, hex:'#d946ef' }, // Pink-500 -> Fuchsia-500
        ];

        // --- Perks & Skills ---
        const PERKS = {
            catalyst: {
                id:'catalyst',
                name:{en:'Catalyst', ja:'è§¦åª’åå¿œ'},
                rarity:'rare',
                desc:{en:'Once per floor: Completing a tube reduces Pressure by 5.', ja:'å„éšå±¤1å›ï¼šè‰²ã‚’å®Œæˆã•ã›ã‚‹ã¨åœ§åŠ›ãŒ5ä¸‹ãŒã‚‹ã€‚'},
            },
            transmutation: {
                id:'transmutation',
                name:{en:'Transmutation', ja:'ç‰©è³ªå¤‰æ›'},
                rarity:'rare',
                desc:{en:'Gain a random item at the start of each floor.', ja:'éšå±¤é–‹å§‹æ™‚ã€ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ã‚¤ãƒ†ãƒ ã‚’1ã¤ç²å¾—ã™ã‚‹ã€‚'},
            },
            momentum: {
                id:'momentum',
                name:{en:'Momentum', ja:'æ…£æ€§å¾‹'},
                rarity:'common',
                desc:{en:'Pressure does not increase on the turn after completing a tube.', ja:'ãƒãƒ¥ãƒ¼ãƒ–ã‚’å®Œæˆã•ã›ãŸç›´å¾Œã®1ã‚¿ãƒ¼ãƒ³ã¯åœ§åŠ›ãŒä¸Šæ˜‡ã—ãªã„ã€‚'},
            },
            reflux: {
                id:'reflux',
                name:{en:'Reflux', ja:'é€†æµåˆ¶å¾¡'},
                rarity:'common',
                desc:{en:'First undo each floor is free (Pressure +2).', ja:'å„éšå±¤ã€æœ€åˆã®Undoã¯ã‚¨ãƒƒã‚»ãƒ³ã‚¹ç„¡æ–™ï¼ˆåœ§åŠ›+2ã§ä»£ç”¨ï¼‰ã€‚'},
            },
            overflow: {
                id:'overflow',
                name:{en:'Overflow', ja:'ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼'},
                rarity:'common',
                desc:{en:'Pressure max +4.', ja:'åœ§åŠ›ã®æœ€å¤§è¨±å®¹é‡ãŒ+4ã•ã‚Œã‚‹ã€‚'},
            },
            purification: {
                id:'purification',
                name:{en:'Purification', ja:'æµ„åŒ–ä½œç”¨'},
                rarity:'epic',
                desc:{en:'Clearing Obsidian (Black) reduces Pressure by 3 and grants 2 Essence.', ja:'é»’ã‚¤ãƒ³ã‚¯ã‚’æ¶ˆæ»…ã•ã›ã‚‹ã¨ã€åœ§åŠ›ãŒ3ä¸‹ãŒã‚Šã€2ã‚¨ãƒƒã‚»ãƒ³ã‚¹ã‚’å¾—ã‚‹ã€‚'},
            },
            scavenger: {
                id:'scavenger',
                name:{en:'Scavenger', ja:'ã‚¹ã‚«ãƒ™ãƒ³ã‚¸ãƒ£ãƒ¼'},
                rarity:'rare',
                desc:{en:'15% chance to find a random item when descending.', ja:'éšå±¤ç§»å‹•æ™‚ã€15%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ã‚¤ãƒ†ãƒ ã‚’æ‹¾ã†ã€‚'},
            },
            bargain: {
                id:'bargain',
                name:{en:'Bargain', ja:'äº¤æ¸‰è¡“'},
                rarity:'common',
                desc:{en:'Shop prices are reduced by 20%.', ja:'ã‚·ãƒ§ãƒƒãƒ—ã®ä¾¡æ ¼ãŒ20%OFFã«ãªã‚‹ã€‚'},
            },
            heavy_mastery: {
                id:'heavy_mastery',
                name:{en:'Heavy Mastery', ja:'å¤§å®¹é‡ãƒœãƒ¼ãƒŠã‚¹'},
                rarity:'rare',
                desc:{en:'Clearing a tube with capacity 5+ reduces Pressure by 3.', ja:'å®¹é‡5ä»¥ä¸Šã®ãƒãƒ¥ãƒ¼ãƒ–ã‚’å®Œæˆã•ã›ã‚‹ã¨åœ§åŠ›ãŒ3ä¸‹ãŒã‚‹ã€‚'},
            },
            deep_adapt: {
                id:'deep_adapt',
                name:{en:'Deep Adapt', ja:'æ·±å±¤é©å¿œ'},
                rarity:'epic',
                desc:{en:'Gain Max HP based on current tube capacity at start of floor.', ja:'éšå±¤é–‹å§‹æ™‚ã€ç¾åœ¨ã®ãƒãƒ¥ãƒ¼ãƒ–å®¹é‡ã«å¿œã˜ã¦æœ€å¤§HPãŒå¢—åŠ ã™ã‚‹ã€‚'},
            }
            ,
            laminar_flow: {
                id:'laminar_flow',
                name:{en:'Laminar Flow', ja:'å±¤æµåˆ¶å¾¡'},
                rarity:'common',
                desc:{en:'Once per floor: Your first pour does not increase Pressure.', ja:'å„éšå±¤1å›ï¼šæœ€åˆã®æ³¨ãã§ã¯åœ§åŠ›ãŒå¢—åŠ ã—ãªã„ã€‚'},
            },
            fine_instruments: {
                id:'fine_instruments',
                name:{en:'Fine Instruments', ja:'ç²¾å¯†å™¨å…·'},
                rarity:'common',
                desc:{en:'Gain a Pipette immediately (if you do not already own one).', ja:'å³åº§ã«ãƒ”ãƒšãƒƒãƒˆã‚’å¾—ã‚‹ï¼ˆæœªæ‰€æŒã®å ´åˆï¼‰ã€‚'},
            },
            residue_refund: {
                id:'residue_refund',
                name:{en:'Residue Refund', ja:'æ®‹æ»“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯'},
                rarity:'common',
                desc:{en:'Once per floor: Your first shop purchase refunds 1 Essence.', ja:'å„éšå±¤1å›ï¼šæœ€åˆã®è³¼å…¥ã§ã‚¨ãƒƒã‚»ãƒ³ã‚¹ã‚’1è¿”é‡‘ã€‚'},
            },
            volatile_ink: {
                id:'volatile_ink',
                name:{en:'Volatile Ink', ja:'æ®ç™ºæ€§ã‚¤ãƒ³ã‚¯'},
                rarity:'common',
                desc:{en:'Evaporating Obsidian grants +1 Essence.', ja:'é»’ã‚¤ãƒ³ã‚¯æ¶ˆæ»…æ™‚ã€è¿½åŠ ã§ã‚¨ãƒƒã‚»ãƒ³ã‚¹+1ã€‚'},
            },
            wardweaver: {
                id:'wardweaver',
                name:{en:'Wardweaver', ja:'è­·ç¬¦ç¹”ã‚Š'},
                rarity:'rare',
                desc:{en:'At start of each floor, gain 1 Black Ward (prevents corrosion once).', ja:'éšå±¤é–‹å§‹æ™‚ã«ãƒ–ãƒ©ãƒƒã‚¯ãƒ¯ãƒ¼ãƒ‰+1ï¼ˆè…é£Ÿã‚’1å›é˜²ãï¼‰ã€‚'},
            },
            recycler: {
                id:'recycler',
                name:{en:'Recycler', ja:'å†åˆ©ç”¨è¡“'},
                rarity:'rare',
                desc:{en:'Consumables have a 20% chance not to be consumed.', ja:'æ¶ˆè€—å“ãŒ20%ã®ç¢ºç‡ã§æ¶ˆè²»ã•ã‚Œãªã„ã€‚'},
            },
            prime_scavenger: {
                id:'prime_scavenger',
                name:{en:'Prime Scavenger', ja:'ä¸Šç´šã‚¹ã‚«ãƒ™ãƒ³ã‚¸ãƒ£ãƒ¼'},
                rarity:'rare',
                desc:{en:'20% chance to find an extra random item when descending.', ja:'éšå±¤ç§»å‹•æ™‚ã€20%ã§è¿½åŠ ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ‹¾ã†ã€‚'},
            },
            reroll_savant: {
                id:'reroll_savant',
                name:{en:'Reroll Savant', ja:'ãƒªãƒ­ãƒ¼ãƒ«é©æ€§'},
                rarity:'rare',
                desc:{en:'Once per floor: Your first REROLL is free.', ja:'å„éšå±¤1å›ï¼šæœ€åˆã®REROLLãŒç„¡æ–™ã€‚'},
            },
            deep_reservoir: {
                id:'deep_reservoir',
                name:{en:'Deep Reservoir', ja:'æ·±å±¤ãƒªã‚¶ãƒ¼ãƒ'},
                rarity:'epic',
                desc:{en:'Pressure max +6.', ja:'åœ§åŠ›ã®æœ€å¤§è¨±å®¹é‡ãŒ+6ã•ã‚Œã‚‹ã€‚'},
            },
            abyssal_patron: {
                id:'abyssal_patron',
                name:{en:'Abyssal Patron', ja:'æ·±æ·µã®å¾Œæ´'},
                rarity:'epic',
                desc:{en:'At start of each floor, gain +2 Essence.', ja:'éšå±¤é–‹å§‹æ™‚ã«ã‚¨ãƒƒã‚»ãƒ³ã‚¹+2ã€‚'},
            }

        };

        const ITEMS = {
            pipette: {
                id: 'pipette',
                type: 'tool', 
                name: {en:'Pipette', ja:'ç²¾å¯†ãƒ”ãƒšãƒƒãƒˆ'},
                desc: {en:'Toggle: Pour only 1 segment.', ja:'åˆ‡æ›¿ï¼š1ç›®ç››ã‚Šã ã‘æ³¨ããƒ¢ãƒ¼ãƒ‰'},
                icon: 'âš—ï¸',
                cost: 10
            },
            inverter: {
                id: 'inverter',
                type: 'consumable',
                name: {en:'Gravity Coil', ja:'é‡åŠ›åè»¢æ©Ÿ'},
                desc: {en:'ã€Useã€‘Invert contents.', ja:'ã€ä½¿ç”¨ã€‘ä¸­èº«ã‚’ä¸Šä¸‹åè»¢'},
                icon: 'ğŸ”„',
                cost: 6
            },
            void_salt: {
                id: 'void_salt',
                type: 'consumable',
                name: {en:'Void Salt', ja:'è™šç„¡ã®å¡©'},
                desc: {en:'ã€Useã€‘Remove top Black.', ja:'ã€ä½¿ç”¨ã€‘ä¸€ç•ªä¸Šã®ã€é»’ã€‘ã‚’é™¤å»'},
                icon: 'ğŸ§‚',
                cost: 8
            },
            separator: {
                id: 'separator',
                type: 'consumable',
                name: {en:'Separator', ja:'é å¿ƒåˆ†é›¢æ©Ÿ'},
                desc: {en:'ã€Useã€‘Sort tube contents.', ja:'ã€ä½¿ç”¨ã€‘ä¸­èº«ã‚’æ•´ç†ã™ã‚‹'},
                icon: 'ğŸŒªï¸',
                cost: 12
            },
            summon_vial: {
                id: 'summon_vial',
                type: 'consumable',
                name: {en:'Extra Vial', ja:'äºˆå‚™ãƒ•ãƒ©ã‚¹ã‚³'},
                desc: {en:'ã€Useã€‘Add an empty tube.', ja:'ã€ä½¿ç”¨ã€‘ç©ºãç“¶ã‚’1ã¤è¿½åŠ '},
                icon: 'ğŸ§ª',
                cost: 15
            },
            cycle_siphon: {
                id: 'cycle_siphon',
                type: 'consumable',
                name: {en:'Cycle Siphon', ja:'å¾ªç’°ã‚µã‚¤ãƒ•ã‚©ãƒ³'},
                desc: {en:'ã€Useã€‘Move bottom to top.', ja:'ã€ä½¿ç”¨ã€‘ä¸€ç•ªä¸‹ã‚’ä¸€ç•ªä¸Šã¸'},
                icon: 'â«',
                cost: 9
            }
            ,
            micro_siphon: {
                id: 'micro_siphon',
                type: 'consumable',
                name: {en:'Micro Siphon', ja:'å¾®å°ã‚µã‚¤ãƒ•ã‚©ãƒ³'},
                desc: {en:'ã€Useã€‘Move top to bottom.', ja:'ã€ä½¿ç”¨ã€‘ä¸€ç•ªä¸Šã‚’ä¸€ç•ªä¸‹ã¸'},
                icon: 'â¬',
                cost: 7
            },
            top_swapper: {
                id: 'top_swapper',
                type: 'consumable',
                name: {en:'Top Swapper', ja:'é ‚éƒ¨ã‚¹ãƒ¯ãƒƒãƒ‘ãƒ¼'},
                desc: {en:'ã€Useã€‘Swap top two segments.', ja:'ã€ä½¿ç”¨ã€‘ä¸€ç•ªä¸Šã®2ã¤ã‚’å…¥ã‚Œæ›¿ãˆ'},
                icon: 'ğŸ”ƒ',
                cost: 7
            },
            black_magnet: {
                id: 'black_magnet',
                type: 'consumable',
                name: {en:'Black Magnet', ja:'é»’ç£çŸ³'},
                desc: {en:'ã€Useã€‘Pull all Black to the top.', ja:'ã€ä½¿ç”¨ã€‘é»’ã‚’ä¸Šã«é›†ã‚ã‚‹'},
                icon: 'ğŸ§²',
                cost: 11
            }

        };

        const SHOP_ITEMS = [
            { id:'heal', type:'stat', name:{en:'Stabilizer', ja:'å®‰å®šå‰¤'}, cost:8, desc:{en:'Heal +1 HP', ja:'HP+1'}, apply(gs){ gs.hp += 1; showToast('HP Recovered!', 'rose'); } },
            { id:'heal2', type:'stat', name:{en:'Coagulant', ja:'å‡å›ºå‰¤'}, cost:13, desc:{en:'Heal +2 HP', ja:'HP+2'}, apply(gs){ gs.hp += 2; showToast('HP Recovered!', 'rose'); } },
            { id:'heal3', type:'stat', name:{en:'Panacea', ja:'ä¸‡èƒ½è–¬'}, cost:19, desc:{en:'Heal +3 HP', ja:'HP+3'}, apply(gs){ gs.hp += 3; showToast('HP Recovered!', 'rose'); } },

            { id:'maxhp1', type:'stat', name:{en:'Reinforced Heart', ja:'å¼·åŒ–å¿ƒè‡“'}, cost:18, desc:{en:'Max HP +1 (also heal +1)', ja:'æœ€å¤§HP+1ï¼ˆåŒæ™‚ã«HP+1ï¼‰'}, apply(gs){ gs.maxHp += 1; gs.hp += 1; showToast(currentLang==='ja'?'æœ€å¤§HPãŒå¢—åŠ ï¼':'Max HP increased!', 'rose'); } },
            { id:'maxhp2', type:'stat', name:{en:'Twin Hearts', ja:'äºŒé‡å¿ƒè‡“'}, cost:30, desc:{en:'Max HP +2 (also heal +2)', ja:'æœ€å¤§HP+2ï¼ˆåŒæ™‚ã«HP+2ï¼‰'}, apply(gs){ gs.maxHp += 2; gs.hp += 2; showToast(currentLang==='ja'?'æœ€å¤§HPãŒå¢—åŠ ï¼':'Max HP increased!', 'rose'); } },

            { id:'relief', type:'stat', name:{en:'Vent Valve', ja:'åœ§åŠ›å¼'}, cost:5, desc:{en:'Pressure -5', ja:'åœ§åŠ›-5'}, apply(gs){ gs.pressure = Math.max(0, gs.pressure-5); showToast('Pressure Released!', 'sky'); } },
            { id:'relief2', type:'stat', name:{en:'Relief Manifold', ja:'æ¸›åœ§ãƒãƒ‹ãƒ›ãƒ¼ãƒ«ãƒ‰'}, cost:9, desc:{en:'Pressure -10', ja:'åœ§åŠ›-10'}, apply(gs){ gs.pressure = Math.max(0, gs.pressure-10); showToast('Pressure Released!', 'sky'); } },
            { id:'relief3', type:'stat', name:{en:'Emergency Purge', ja:'ç·Šæ€¥æ’æ°—'}, cost:14, desc:{en:'Pressure -18', ja:'åœ§åŠ›-18'}, apply(gs){ gs.pressure = Math.max(0, gs.pressure-18); showToast('Pressure Released!', 'sky'); } },
            { id:'relief0', type:'stat', name:{en:'Full Vent', ja:'å…¨æ’æ°—'}, cost:12, desc:{en:'Set Pressure to 0', ja:'åœ§åŠ›ã‚’0ã«ã™ã‚‹'}, apply(gs){ gs.pressure = 0; showToast('Pressure Released!', 'sky'); } },

            { id:'cap2', type:'stat', name:{en:'Pressure Reservoir', ja:'åœ§åŠ›ãƒªã‚¶ãƒ¼ãƒ'}, cost:14, desc:{en:'Pressure max +2', ja:'åœ§åŠ›ä¸Šé™+2'}, apply(gs){ gs.pressureMax += 2; showToast(currentLang==='ja'?'åœ§åŠ›ä¸Šé™ãŒå¢—åŠ ï¼':'Pressure max increased!', 'sky'); } },
            { id:'cap4', type:'stat', name:{en:'Reinforced Chamber', ja:'å¼·åŒ–ãƒãƒ£ãƒ³ãƒãƒ¼'}, cost:22, desc:{en:'Pressure max +4', ja:'åœ§åŠ›ä¸Šé™+4'}, apply(gs){ gs.pressureMax += 4; showToast(currentLang==='ja'?'åœ§åŠ›ä¸Šé™ãŒå¢—åŠ ï¼':'Pressure max increased!', 'sky'); } },
            { id:'cap6', type:'stat', name:{en:'Deep Chamber', ja:'æ·±å±¤ãƒãƒ£ãƒ³ãƒãƒ¼'}, cost:30, desc:{en:'Pressure max +6', ja:'åœ§åŠ›ä¸Šé™+6'}, apply(gs){ gs.pressureMax += 6; showToast(currentLang==='ja'?'åœ§åŠ›ä¸Šé™ãŒå¢—åŠ ï¼':'Pressure max increased!', 'sky'); } },

            { id:'blackward1', type:'stat', name:{en:'Black Ward', ja:'ãƒ–ãƒ©ãƒƒã‚¯ãƒ¯ãƒ¼ãƒ‰'}, cost:10, desc:{en:'Prevent corrosion once.', ja:'è…é£Ÿï¼ˆé»’åŒ–ï¼‰ã‚’1å›é˜²ã'}, apply(gs){ gs.blackWard = (gs.blackWard||0) + 1; showToast(currentLang==='ja'?'è­·ç¬¦ãŒè„ˆå‹•ã—ã¦ã„ã‚‹â€¦':'A ward hums softlyâ€¦', 'purple'); } },
            { id:'blackward2', type:'stat', name:{en:'Black Ward x2', ja:'ãƒ–ãƒ©ãƒƒã‚¯ãƒ¯ãƒ¼ãƒ‰Ã—2'}, cost:18, desc:{en:'Prevent corrosion twice.', ja:'è…é£Ÿï¼ˆé»’åŒ–ï¼‰ã‚’2å›é˜²ã'}, apply(gs){ gs.blackWard = (gs.blackWard||0) + 2; showToast(currentLang==='ja'?'è­·ç¬¦ãŒè„ˆå‹•ã—ã¦ã„ã‚‹â€¦':'A ward hums softlyâ€¦', 'purple'); } },

            { id:'coupon1', type:'stat', name:{en:'Reroll Coupon', ja:'ãƒªãƒ­ãƒ¼ãƒ«ã‚¯ãƒ¼ãƒãƒ³'}, cost:7, desc:{en:'Your next REROLL is free.', ja:'æ¬¡å›ã®REROLLãŒç„¡æ–™ã«ãªã‚‹'}, apply(gs){ gs.rerollCoupons = (gs.rerollCoupons||0) + 1; showToast(currentLang==='ja'?'ã‚¯ãƒ¼ãƒãƒ³ã‚’ç²å¾—ï¼':'Coupon acquired!', 'emerald'); } },
            { id:'coupon2', type:'stat', name:{en:'Reroll Coupon x2', ja:'ãƒªãƒ­ãƒ¼ãƒ«ã‚¯ãƒ¼ãƒãƒ³Ã—2'}, cost:12, desc:{en:'Gain 2 coupons.', ja:'ã‚¯ãƒ¼ãƒãƒ³ã‚’2æšå¾—ã‚‹'}, apply(gs){ gs.rerollCoupons = (gs.rerollCoupons||0) + 2; showToast(currentLang==='ja'?'ã‚¯ãƒ¼ãƒãƒ³ã‚’ç²å¾—ï¼':'Coupon acquired!', 'emerald'); } },

            { id:'buy_pipette', type:'item', ref: ITEMS.pipette },
            { id:'buy_inverter', type:'item', ref: ITEMS.inverter },
            { id:'buy_separator', type:'item', ref: ITEMS.separator },
            { id:'buy_siphon', type:'item', ref: ITEMS.cycle_siphon },
            { id:'buy_micro', type:'item', ref: ITEMS.micro_siphon },
            { id:'buy_swap', type:'item', ref: ITEMS.top_swapper },
            { id:'buy_magnet', type:'item', ref: ITEMS.black_magnet },
            { id:'buy_void', type:'item', ref: ITEMS.void_salt },
            { id:'buy_summon', type:'item', ref: ITEMS.summon_vial },

            { id:'void_bundle', type:'stat', name:{en:'Void Salt x2', ja:'è™šç„¡ã®å¡©Ã—2'}, cost:14, desc:{en:'Gain 2 Void Salts.', ja:'è™šç„¡ã®å¡©ã‚’2ã¤å¾—ã‚‹'}, apply(gs){ const id='void_salt'; if(!gs.inventory[id]) gs.inventory[id]=0; gs.inventory[id]+=2; showToast(currentLang==='ja'?'è™šç„¡ã®å¡©ã‚’è£œçµ¦ï¼':'Void Salt stocked!', 'sky'); } },
            { id:'salvage_pack', type:'stat', name:{en:'Salvage Pack', ja:'å›åãƒ‘ãƒƒã‚¯'}, cost:11, desc:{en:'Gain 2 random consumables.', ja:'ãƒ©ãƒ³ãƒ€ãƒ ãªæ¶ˆè€—å“ã‚’2ã¤å¾—ã‚‹'}, apply(gs){
                const pool = ['inverter','void_salt','separator','cycle_siphon','micro_siphon','top_swapper','black_magnet'];
                for(let k=0;k<2;k++){ const gift = pick(pool); if(!gs.inventory[gift]) gs.inventory[gift]=0; gs.inventory[gift]++; }
                showToast(currentLang==='ja'?'å›åãƒ‘ãƒƒã‚¯ã‚’é–‹å°ï¼':'Salvage acquired!', 'sky');
            } },
            { id:'adept_pack', type:'stat', name:{en:'Adept Pack', ja:'ç†Ÿç·´ãƒ‘ãƒƒã‚¯'}, cost:16, desc:{en:'Gain 3 random consumables.', ja:'ãƒ©ãƒ³ãƒ€ãƒ ãªæ¶ˆè€—å“ã‚’3ã¤å¾—ã‚‹'}, apply(gs){
                const pool = ['inverter','void_salt','separator','cycle_siphon','micro_siphon','top_swapper','black_magnet'];
                for(let k=0;k<3;k++){ const gift = pick(pool); if(!gs.inventory[gift]) gs.inventory[gift]=0; gs.inventory[gift]++; }
                showToast(currentLang==='ja'?'ç†Ÿç·´ãƒ‘ãƒƒã‚¯ã‚’é–‹å°ï¼':'Adept stash acquired!', 'sky');
            } },
        ];

        const SHOP_DISPLAY_COUNT = 8;

        function rollShopOffers(){
            const all = SHOP_ITEMS;

            const toolFiltered = all.filter(it => {
                if(it.type !== 'item') return true;
                const def = it.ref;
                if(def?.type === 'tool' && gameState.inventory?.[def.id]) return false;
                return true;
            });

            const pool = toolFiltered.length >= SHOP_DISPLAY_COUNT ? toolFiltered : all;

            const picks = [];
            const safe = [...pool];
            while(picks.length < SHOP_DISPLAY_COUNT && safe.length > 0){
                const idx = randInt(safe.length);
                picks.push(safe[idx]);
                safe.splice(idx, 1);
            }
            return picks;
        }

        function getRerollMeta(){
            const coupons = gameState.rerollCoupons || 0;
            const free = !!gameState.freeRerollThisFloor;
            const can = free || coupons > 0 || gameState.essence >= 5;
            let label = 'Reroll (-5âœ¨)';
            if(free) label = 'Reroll (FREE)';
            else if(coupons > 0) label = `Reroll (COUPON x${coupons})`;
            return {can, label};
        }

        function refreshRerollUI(){
            if(!rerollBtn) return;
            const meta = getRerollMeta();
            rerollBtn.classList.toggle('hidden', !meta.can);
            rerollBtn.textContent = meta.label;
        }


        // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
        const gameState = {
            floor: 1,
            essence: 0,
            hp: 3,
            maxHp: 3,
            turnCount: 0, 
            capacity: 4,
            tubeCount: 0,
            selectedIdx: null,
            tubes: [],
            busy: false,
            perks: new Set(),
            inventory: {}, 
            pressure: 0,
            pressureMax: 14,
            catalystAvailable: true,
            refluxArmed: false,
            momentumActive: false, // New State
            history: [],
            primaryGoal: null,
            secondaryGoal: null,
            secondaryProgress: 0,
            focusIdx: null, 
            currentPerkChoices: null,
            pipetteMode: false,
            targetMode: null, 
            blackWard: 0,
            rerollCoupons: 0,
            currentShopOffers: null,
            residueRefundUsedThisFloor: false,
            laminarUsedThisFloor: false,
            freeRerollThisFloor: false,
        };

        // --- DOM ---
        const tubesContainer = ui('tubes-container');
        const boardArea = ui('board-area'); // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—ç”¨
        const skillsContainer = ui('skills-container');
        const startScreen = ui('start-screen');
        const perkScreen = ui('perk-screen');
        const perkCards = ui('perk-cards');
        const shopCards = ui('shop-cards');
        const continueBtn = ui('continue-btn');
        const rerollBtn = ui('reroll-btn');
        const helpScreen = ui('help-screen');
        const settingsScreen = ui('settings-screen');
        const eventScreen = ui('event-screen');
        const eventChoices = ui('event-choices');
        const devTests = ui('dev-tests');
        const alertBanner = ui('alert-banner');
        const undoBtn = ui('btn-undo');

        // --- Game Logic ---

        function tubeTop(t){ return t.length ? t[t.length-1] : null; }
        function tubeFree(t){ return gameState.capacity - t.length; }
        function isCompleteTube(t){
            if (t.length !== gameState.capacity) return false;
            return t.every(c => c === t[0]);
        }
        function colorMeta(key){ return COLOR_POOL.find(c => c.key===key); }
        function colorName(key){ const m=colorMeta(key); return currentLang==='ja' ? m.name.ja : m.name.en; }

        function generateGoals(){
            const flat = gameState.tubes.flat();
            const presentColors = new Set(flat);
            presentColors.delete('K'); 
            const colors = [...presentColors];

            if (colors.length === 0) {
                gameState.primaryGoal = { type:'survive', text: currentLang==='ja'?'ç”Ÿãå»¶ã³ã‚':'Survive' };
                return;
            }

            const roll = Math.random();
            if (roll < 0.50){
                const maxN = colors.length;
                const n = clamp(Math.floor(maxN / 1.5), 1, maxN);
                gameState.primaryGoal = {
                    type:'completeN', n:n,
                    text: currentLang==='ja' ? `ã„ãšã‚Œã‹${n}è‰²ã‚’å®Œæˆ` : `Complete any ${n} colors`
                };
            } else {
                const c = pick(colors);
                gameState.primaryGoal = {
                    type:'completeColor', color:c,
                    text: currentLang==='ja' ? `${colorName(c)}ã‚’å®Œæˆ` : `Complete ${colorName(c)}`
                };
            }
            
            const sroll = Math.random();
            const par = 14 + Math.floor(gameState.floor / 2) + 5; 
            if (sroll < 0.5){
                gameState.secondaryGoal = {
                    type:'speed', limit: par,
                    text: currentLang==='ja' ? `${par}ã‚¿ãƒ¼ãƒ³ä»¥å†…ã«1æœ¬å®Œæˆ` : `Complete 1 within ${par} turns`
                };
            } else {
                gameState.secondaryGoal = {
                    type:'combo', need:2,
                    text: currentLang==='ja' ? 'é€£ç¶šå®Œæˆï¼ˆã‚³ãƒ³ãƒœï¼‰' : 'Combo: 2 in a row'
                };
            }
            gameState.secondaryProgress = 0;
            renderHUD();
        }

        function checkPrimaryGoal(){
            if (gameState.primaryGoal.type === 'completeN') {
                return countCompletedTubes() >= gameState.primaryGoal.n;
            }
            if (gameState.primaryGoal.type === 'completeColor'){
                return gameState.tubes.some(t => isCompleteTube(t) && t[0] === gameState.primaryGoal.color);
            }
            if (gameState.primaryGoal.type === 'survive') return false; 
            return false;
        }
        
        function checkLevelClear(){
            if (checkPrimaryGoal()) return true;
            const allClean = gameState.tubes.every(t => t.length === 0 || (isCompleteTube(t) && t[0] !== 'K'));
            if (allClean) return true;
            return false;
        }

        function checkSecondaryGoalOnComplete(){
            if (!gameState.secondaryGoal) return;
            if (gameState.secondaryGoal.type === 'speed'){
                if (gameState.turnCount <= gameState.secondaryGoal.limit){
                    gameState.secondaryProgress = 1; 
                }
            } else if (gameState.secondaryGoal.type === 'combo'){
                gameState.secondaryProgress += 1;
            }
        }

        function secondarySucceeded(){
            if (!gameState.secondaryGoal) return false;
            if (gameState.secondaryGoal.type === 'speed') return gameState.secondaryProgress >= 1;
            if (gameState.secondaryGoal.type === 'combo') return gameState.secondaryProgress >= gameState.secondaryGoal.need;
            return false;
        }
        
        function isDeadlocked(){
            for(let i=0; i<gameState.tubes.length; i++){
                if(gameState.tubes[i].length === 0) continue; 
                for(let j=0; j<gameState.tubes.length; j++){
                    if(i===j) continue;
                    const check = canPour(i, j);
                    if(check.ok) return false; 
                }
            }
            return true; 
        }

        function generateBoard(){
            const floor = gameState.floor;
            gameState.tubeCount = Math.min(10, 6 + Math.floor((floor-1)/2));
            const numColors = gameState.tubeCount - 2;

            const safeNumColors = Math.min(numColors, COLOR_POOL.length);
            
            const pool = COLOR_POOL.slice(0, Math.min(COLOR_POOL.length, safeNumColors + (floor > 5 ? 1 : 0))).map(c=>c.key);
            const colors = [];
            
            let failsafe = 0;
            while(colors.length < safeNumColors){
                const c = pick(pool);
                if(!colors.includes(c)) colors.push(c);
                
                failsafe++;
                if(failsafe > 100) break; 
            }

            const bag = [];
            for (const c of colors) for (let i=0;i<gameState.capacity;i++) bag.push(c);

            for (let i=bag.length-1;i>0;i--){
                const j = randInt(i+1);
                [bag[i], bag[j]] = [bag[j], bag[i]];
            }

            const tubes = Array.from({length: gameState.tubeCount}, () => []);
            let k=0;
            for (let t=0;t<safeNumColors;t++){
                for (let s=0;s<gameState.capacity;s++) {
                    if(k < bag.length) tubes[t].push(bag[k++]);
                }
            }

            for (let i=0;i<20;i++){
                const t1 = randInt(safeNumColors);
                const t2 = randInt(safeNumColors);
                if (t1===t2) continue;
                const s1 = randInt(gameState.capacity);
                const s2 = randInt(gameState.capacity);
                if(tubes[t1][s1] && tubes[t2][s2]) {
                    [tubes[t1][s1], tubes[t2][s2]] = [tubes[t2][s2], tubes[t1][s1]];
                }
            }

            gameState.tubes = tubes;
            updateTubeLayout();
        }
        
        function updateTubeLayout(){
            const cap = gameState.capacity;
            let segHeight = 40;
            if(cap >= 6) segHeight = 32;
            else if(cap >= 5) segHeight = 36;
            
            // ãƒãƒ¥ãƒ¼ãƒ–ã®é«˜ã•ã‚’å®¹é‡ã«åˆã‚ã›ã¦è¨ˆç®— (segHeight * cap + top/bottom padding approx 20-30px)
            // å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ (ä¾‹: +40px)
            const tubeHeight = (segHeight * cap) + 40;

            document.documentElement.style.setProperty('--segment-height', `${segHeight}px`);
            document.documentElement.style.setProperty('--tube-height', `${tubeHeight}px`);
        }

        // --- Render ---
        function renderBoard(){
            tubesContainer.innerHTML = '';
            
            const deadlocked = isDeadlocked();
            if (alertBanner) alertBanner.style.opacity = deadlocked ? '1' : '0';

            gameState.tubes.forEach((segments, i) => {
                const tube = document.createElement('div');
                tube.className = 'tube';
                tube.dataset.idx = String(i);

                if (i === gameState.selectedIdx) tube.classList.add('selected');
                
                if (gameState.focusIdx !== null && i === gameState.focusIdx) {
                    tube.classList.add('tube-focused');
                }
                
                if (deadlocked) tube.classList.add('deadlock-glow');
                
                if (gameState.targetMode) {
                    tube.classList.add('target-mode');
                    tube.style.cursor = 'crosshair';
                }

                if (isCompleteTube(segments)) {
                    if (segments[0] !== 'K') {
                        tube.style.boxShadow = `0 0 15px ${colorMeta(segments[0]).hex}`;
                        tube.style.borderColor = `rgba(255,255,255,0.5)`;
                    }
                }

                const water = document.createElement('div');
                water.className = 'water-container';

                segments.forEach(key => {
                    const c = colorMeta(key)?.hex || '#64748b';
                    const seg = document.createElement('div');
                    seg.className = 'water-segment';
                    seg.style.backgroundColor = c;
                    water.appendChild(seg);
                });

                tube.appendChild(water);
                tube.addEventListener('click', () => handleTubeClick(i));
                tubesContainer.appendChild(tube);
            });
            
            renderSkills();
            
            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾Œã«ã‚µã‚¤ã‚ºèª¿æ•´ã‚’å®Ÿè¡Œ
            // DOMæ›´æ–°å®Œäº†ã‚’å¾…ã¤ãŸã‚ã«requestAnimationFrameã‚’ä½¿ç”¨
            requestAnimationFrame(adjustBoardScale);
        }
        
        // --- è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‡¦ç† ---
        function adjustBoardScale() {
            if (!boardArea || !tubesContainer) return;
            
            // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆã—ã¦æœ¬æ¥ã®ã‚µã‚¤ã‚ºã‚’è¨ˆæ¸¬
            tubesContainer.style.transform = 'none';
            
            const availableW = boardArea.clientWidth;
            const availableH = boardArea.clientHeight;
            
            const contentW = tubesContainer.scrollWidth;
            const contentH = tubesContainer.scrollHeight;
            
            // ãƒãƒ¼ã‚¸ãƒ³åˆ†ã‚’è€ƒæ…®ã—ã¦å°‘ã—å°ã•ã‚ã«
            const safeW = availableW * 0.95;
            const safeH = availableH * 0.95;
            
            let scale = 1;
            
            if (contentW > safeW || contentH > safeH) {
                scale = Math.min(safeW / contentW, safeH / contentH);
            }
            
            // æ¥µç«¯ã«å°ã•ããªã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ (ä¾‹: 0.4å€ã¾ã§)
            scale = Math.max(scale, 0.4);
            
            if (scale < 1) {
                tubesContainer.style.transform = `scale(${scale})`;
            }
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã‚‚å®Ÿè¡Œ
        window.addEventListener('resize', () => {
            requestAnimationFrame(adjustBoardScale);
        });
        
        function renderSkills(){
            skillsContainer.innerHTML = '';
            // Inventory check
            Object.keys(gameState.inventory).forEach(key => {
                const count = gameState.inventory[key];
                if(count > 0 || ITEMS[key].type === 'tool'){
                    const def = ITEMS[key];
                    const btn = document.createElement('button');
                    btn.className = 'skill-btn w-12 h-12 glass-panel flex items-center justify-center text-xl rounded-full border border-white/10 shrink-0';
                    
                    // Name and Desc
                    const name = currentLang==='ja' ? def.name.ja : def.name.en;
                    const desc = currentLang==='ja' ? def.desc.ja : def.desc.en;

                    // Badge and Tooltip HTML
                    let badgeHtml = '';
                    if(def.type === 'consumable'){
                        badgeHtml = `<span class="absolute -top-1 -right-1 bg-sky-500 text-[10px] font-bold px-1.5 rounded-full text-white pointer-events-none">${count}</span>`;
                    }

                    btn.innerHTML = `
                        ${def.icon}
                        ${badgeHtml}
                        <div class="skill-tooltip">
                            <div class="font-bold text-sky-300 text-xs mb-1">${name}</div>
                            <div class="text-slate-300 text-[10px] leading-tight whitespace-pre-wrap">${desc}</div>
                        </div>
                    `;
                    
                    // Active state
                    if(key === 'pipette' && gameState.pipetteMode) btn.classList.add('active');
                    if(gameState.targetMode === key) btn.classList.add('active-mode');

                    btn.onclick = () => activateSkill(key);
                    skillsContainer.appendChild(btn);
                }
            });
        }

        function activateSkill(key){
            if(gameState.busy) return;
            const def = ITEMS[key];
            
            if(def.id === 'summon_vial'){
                 if(gameState.inventory[key] > 0){
                     gameState.inventory[key]--;
                     gameState.tubeCount++;
                     gameState.tubes.push([]); // ç©ºã®ãƒãƒ¥ãƒ¼ãƒ–è¿½åŠ 
                     // Fix: Render board first, then show float text on the new tube
                     renderBoard();
                     showFloatText(gameState.tubes.length-1, "Summoned!", "#a855f7");
                     showToast(currentLang==='ja'?'ç©ºãç“¶ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼':'Extra Tube Added!', 'purple');
                 }
                 return;
            }
            
            if(def.type === 'tool' && key === 'pipette'){
                // Toggle
                gameState.pipetteMode = !gameState.pipetteMode;
                gameState.targetMode = null; 
                gameState.selectedIdx = null; 
            } else if (def.type === 'consumable'){
                // Toggle Target Mode
                if(gameState.targetMode === key){
                    gameState.targetMode = null; 
                } else {
                    gameState.targetMode = key;
                    gameState.selectedIdx = null; 
                    gameState.pipetteMode = false; 
                    
                    // Hint text logic removed; replaced with toast for feedback
                    showToast(currentLang==='ja' ? "å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„" : "Select a target tube", 'sky');
                }
            }
            renderBoard();
        }

        async function handleTubeClick(idx) {
            if (gameState.busy) return;
            
            // --- Skill Target Logic ---
            if (gameState.targetMode) {
                await applySkillEffect(idx);
                return;
            }

            const content = gameState.tubes[idx];

            // é¸æŠè§£é™¤
            if (gameState.selectedIdx === idx) {
                gameState.selectedIdx = null;
                renderBoard();
                return;
            }

            // æ–°è¦é¸æŠ
            if (gameState.selectedIdx === null) {
                if (content.length === 0) return;
                
                // å®Œæˆã—ãŸãƒãƒ¥ãƒ¼ãƒ–ã¯é¸æŠä¸å¯ï¼ˆé»’ã‚¤ãƒ³ã‚¯å«ã‚€ï¼‰
                // å…ƒ: && !gameState.unsealActive ãŒã‚ã£ãŸãŒå‰Šé™¤
                if (isCompleteTube(content)) return; 

                gameState.selectedIdx = idx;
                renderBoard();
            } else {
                // ç§»å‹•è©¦è¡Œ
                await tryPour(gameState.selectedIdx, idx);
            }
        }
        
        async function applySkillEffect(idx){
            const skillKey = gameState.targetMode;
            const tube = gameState.tubes[idx];

            if(!skillKey || !gameState.inventory[skillKey] || gameState.inventory[skillKey] <= 0) return;

            let success = false;

            const tryConsume = () => {
                if(gameState.perks.has('recycler') && Math.random() < 0.20){
                    showFloatText(idx, currentLang==='ja' ? "å†åˆ©ç”¨!" : "Recycled!", "#22c55e");
                    return; // not consumed
                }
                gameState.inventory[skillKey]--;
            };

            try {
                gameState.busy = true;

                if(skillKey === 'inverter'){
                    if(tube.length < 2) {
                        showFloatText(idx, "Too Empty!", "#ef4444");
                    } else {
                        pushHistory();
                        tryConsume();
                        tube.reverse();
                        showFloatText(idx, "Inverted!", "#a855f7");
                        success = true;
                    }
                } else if (skillKey === 'void_salt'){
                    if(tube.length === 0){
                        showFloatText(idx, "Empty!", "#ef4444");
                    } else {
                        const topColor = tube[tube.length-1];
                        if(topColor !== 'K'){
                            showFloatText(idx, "Pure Element!", "#ef4444");
                        } else {
                            pushHistory();
                            tryConsume();
                            tube.pop();
                            showFloatText(idx, "Voided!", "#a855f7");
                            success = true;
                        }
                    }
                } else if (skillKey === 'separator'){
                    if(tube.length < 2) {
                        showFloatText(idx, "No need!", "#ef4444");
                    } else {
                        pushHistory();
                        tryConsume();
                        const counts = {};
                        const order = [];
                        for(const c of tube){
                            if(!counts[c]) { counts[c]=0; order.push(c); }
                            counts[c]++;
                        }
                        const newTube = [];
                        for(const c of order){
                            for(let i=0; i<counts[c]; i++) newTube.push(c);
                        }
                        gameState.tubes[idx] = newTube;
                        showFloatText(idx, "Separated!", "#a855f7");
                        success = true;
                    }
                } else if (skillKey === 'cycle_siphon'){
                    if(tube.length === 0) {
                        showFloatText(idx, "Empty!", "#ef4444");
                    } else {
                        pushHistory();
                        tryConsume();
                        const bottom = tube.shift();
                        tube.push(bottom);
                        showFloatText(idx, "Cycled!", "#a855f7");
                        success = true;
                    }
                } else if (skillKey === 'micro_siphon'){
                    if(tube.length === 0) {
                        showFloatText(idx, "Empty!", "#ef4444");
                    } else {
                        pushHistory();
                        tryConsume();
                        const top = tube.pop();
                        tube.unshift(top);
                        showFloatText(idx, currentLang==='ja' ? "ç§»é€!" : "Shifted!", "#a855f7");
                        success = true;
                    }
                } else if (skillKey === 'top_swapper'){
                    if(tube.length < 2) {
                        showFloatText(idx, "Too Empty!", "#ef4444");
                    } else {
                        pushHistory();
                        tryConsume();
                        const a = tube.pop();
                        const b = tube.pop();
                        tube.push(a);
                        tube.push(b);
                        showFloatText(idx, currentLang==='ja' ? "äº¤æ›!" : "Swapped!", "#a855f7");
                        success = true;
                    }
                } else if (skillKey === 'black_magnet'){
                    const blacks = tube.filter(c => c === 'K').length;
                    if(blacks === 0){
                        showFloatText(idx, currentLang==='ja' ? "é»’ãªã—" : "No Black", "#ef4444");
                    } else if (tube.length < 2){
                        showFloatText(idx, "No need!", "#ef4444");
                    } else {
                        pushHistory();
                        tryConsume();
                        const others = tube.filter(c => c !== 'K');
                        const ks = new Array(blacks).fill('K');
                        gameState.tubes[idx] = others.concat(ks);
                        showFloatText(idx, currentLang==='ja' ? "å¸ç€!" : "Magnetized!", "#a855f7");
                        success = true;
                    }
                }
            } finally {
                gameState.busy = false;
            }

            if(success){
                gameState.targetMode = null;
                renderHUD();
                renderBoard();

                // Check if skill caused completion
                if(isCompleteTube(gameState.tubes[idx])){
                    await handleCompletion(idx, gameState.tubes[idx][0]);
                }
            }
        }

        function canPour(fromIdx, toIdx){
            if (fromIdx === toIdx) return {ok:false, reason:'same'};
            const from = gameState.tubes[fromIdx];
            const to = gameState.tubes[toIdx];
            if (!from.length) return {ok:false, reason:'empty'};
            if (tubeFree(to) <= 0) return {ok:false, reason:'full'};

            const top = tubeTop(from);
            const toTop = tubeTop(to);

            if (toTop && toTop !== top) return {ok:false, reason:'mismatch'};

            // ç§»å‹•é‡è¨ˆç®—
            let count = 1;
            // Pipette Mode: Force 1
            if(gameState.pipetteMode){
                count = 1;
            } else {
                for (let i=from.length-2;i>=0;i--){
                    if (from[i] === top) count++;
                    else break;
                }
            }
            
            const moveCount = Math.min(count, tubeFree(to));
            return {ok:true, color: top, moveCount};
        }

        function pushHistory(){
            gameState.history.push({
                tubes: deepCopy(gameState.tubes),
                turnCount: gameState.turnCount,
                pressure: gameState.pressure,
                hp: gameState.hp,
                secondaryProgress: gameState.secondaryProgress,
                catalystAvailable: gameState.catalystAvailable,
                essence: gameState.essence,
                inventory: {...gameState.inventory},
                blackWard: gameState.blackWard || 0,
                rerollCoupons: gameState.rerollCoupons || 0,
                residueRefundUsedThisFloor: !!gameState.residueRefundUsedThisFloor,
                laminarUsedThisFloor: !!gameState.laminarUsedThisFloor,
                capacity: gameState.capacity,
                freeRerollThisFloor: !!gameState.freeRerollThisFloor,
                tubeCount: gameState.tubeCount,
                momentumActive: gameState.momentumActive 
            });
            if (gameState.history.length > 50) gameState.history.shift();
        }

        async function tryPour(fromIdx, toIdx){
            const check = canPour(fromIdx, toIdx);
            if (!check.ok){
                const content = gameState.tubes[toIdx];
                // Unseal Removed: å®Œäº†ã—ãŸãƒãƒ¥ãƒ¼ãƒ–ã¯é¸æŠä¸å¯
                if (content.length > 0 && !isCompleteTube(content)) {
                    gameState.selectedIdx = toIdx;
                } else {
                    gameState.selectedIdx = null;
                }
                renderBoard();
                return;
            }

            try {
                pushHistory();
                gameState.busy = true;
                
                // --- Momentum / Laminar Check ---
                if(gameState.momentumActive){
                    // åœ§åŠ›ä¸Šæ˜‡ãªã—
                    gameState.momentumActive = false; // æ¶ˆè²»
                    showFloatText(toIdx, "Momentum!", "#a855f7");
                } else if (gameState.perks.has('laminar_flow') && !gameState.laminarUsedThisFloor){
                    gameState.laminarUsedThisFloor = true; // First pour this floor
                    showFloatText(toIdx, currentLang==='ja' ? "å±¤æµ!" : "Laminar!", "#38bdf8");
                } else {
                    gameState.pressure += 1;
                }
                
                gameState.turnCount += 1;

                // Visual stream: æ•°é‡ã‚‚æ¸¡ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ¶å¾¡
                await animatePour(fromIdx, toIdx, check.color, check.moveCount);

                const from = gameState.tubes[fromIdx];
                const to = gameState.tubes[toIdx];
                const moveCount = check.moveCount;

                for (let i=0;i<moveCount;i++){
                    to.push(from.pop());
                }

                // Check completion for the destination tube
                if(isCompleteTube(to)){
                    await handleCompletion(toIdx, to[0]);
                } else {
                    if (gameState.secondaryGoal?.type === 'combo') gameState.secondaryProgress = 0;
                }

                if (gameState.pressure >= gameState.pressureMax){
                    gameState.pressure = 0;
                    gameState.hp -= 1;
                    ui('game-container').classList.add('animate-shake');
                    setTimeout(()=>ui('game-container').classList.remove('animate-shake'), 500);
                    let warded = false;
                    if((gameState.blackWard||0) > 0){
                        gameState.blackWard -= 1;
                        warded = true;
                        showFloatText(toIdx, currentLang==='ja' ? "è­·ç¬¦!" : "Ward!", "#a855f7");
                    }
                    if(!warded){
                        corruptRandomSegment();
                    }
                }
            } catch (e) {
                console.error("Game Logic Error:", e);
            } finally {
                gameState.selectedIdx = null;
                gameState.busy = false;
            }

            // æ­»äº¡åˆ¤å®šã‚’HPã®ã¿ã«å¤‰æ›´
            if (gameState.hp <= 0){
                openPerkScreen(true);
                return;
            }

            // All Clearåˆ¤å®šã‚’ä½¿ç”¨
            if (checkLevelClear()){
                gameState.essence += 6 + (secondarySucceeded() ? 4 : 0);
                setTimeout(() => openPerkScreen(false), 500);
                return;
            }

            renderHUD();
            renderBoard();
        }

        async function handleCompletion(tubeIdx, colorKey){
            const tubeEl = tubeCenterEl(tubeIdx);
            
            // é»’ã‚¤ãƒ³ã‚¯ã®å ´åˆï¼šæ¶ˆæ»…å‡¦ç†
            if (colorKey === 'K') {
                showFloatText(tubeIdx, "Purged!", "#94a3b8");
                
                // Perk: Purification check
                if(gameState.perks.has('purification')){
                    gameState.pressure = Math.max(0, gameState.pressure - 3);
                    gameState.essence += 2;
                    showFloatText(tubeIdx, "Purified! (-3 Pressure)", "#38bdf8");
                }
                
                // Perk: Volatile Ink
                if(gameState.perks.has('volatile_ink')){
                    gameState.essence += 1;
                    showFloatText(tubeIdx, currentLang==='ja' ? "+1âœ¨" : "+1âœ¨", "#22c55e");
                }

                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¾…æ©Ÿ
                tubeEl.classList.add('evaporating');
                await new Promise(r => setTimeout(r, 600));
                
                gameState.tubes[tubeIdx] = []; // Empty the tube
                tubeEl.classList.remove('evaporating');
                
                // é»’æ¶ˆæ»…å¾Œã€ç›¤é¢ã®å†æç”»ã¨ã‚¯ãƒªã‚¢åˆ¤å®šã‚’è¡Œã†
                renderBoard();
                
                if (checkLevelClear()){
                    gameState.essence += 6 + (secondarySucceeded() ? 4 : 0);
                    setTimeout(() => openPerkScreen(false), 500);
                }
                
                return; // ã‚¤ãƒ™ãƒ³ãƒˆã¯ç™ºç”Ÿã—ãªã„
            }

            // é€šå¸¸è‰²ã®å ´åˆ
            if (gameState.perks.has('catalyst') && gameState.catalystAvailable){
                gameState.pressure = Math.max(0, gameState.pressure - 5);
                gameState.catalystAvailable = false;
                showFloatText(tubeIdx, "Catalyst! (-5 Pressure)");
            }
            
            // Perk: Heavy Mastery
            if(gameState.perks.has('heavy_mastery') && gameState.capacity >= 5){
                 gameState.pressure = Math.max(0, gameState.pressure - 3);
                 showFloatText(tubeIdx, "Heavy Bonus! (-3 Pressure)", "#a855f7");
            }
            
            // Perk: Momentum Activate
            if(gameState.perks.has('momentum')){
                gameState.momentumActive = true;
                // Float text will be shown on next move
            }
            
            checkSecondaryGoalOnComplete();
            await showCompletionEvent(colorKey);
        }

        function countCompletedTubes(){
            // é»’ã‚¤ãƒ³ã‚¯å®Œäº†ã¯ä¸€ç¬ã§æ¶ˆãˆã‚‹ã®ã§ã€ã“ã®åˆ¤å®šã«æ®‹ã‚‹ã“ã¨ã¯ã»ã¼ãªã„ãŒã€
            // å®Œäº†çŠ¶æ…‹ = å®¹é‡Maxã‹ã¤åŒè‰²
            return gameState.tubes.filter(t => isCompleteTube(t) && t[0] !== 'K').length;
        }

        function corruptRandomSegment(){
            const candidates = [];
            for (let i=0;i<gameState.tubes.length;i++){
                const t = gameState.tubes[i];
                // å¤‰æ›´ç‚¹: ãƒˆãƒƒãƒ—ãŒé»’('K')ã§ãªã„å ´åˆã®ã¿å€™è£œã«ã™ã‚‹
                if (t.length < gameState.capacity && (t.length === 0 || t[t.length-1] !== 'K')) {
                    candidates.push(i);
                }
            }
            if (!candidates.length) return;

            const idx = pick(candidates);
            gameState.tubes[idx].push('K');
            showFloatText(idx, "CORRUPTED!", "#ef4444");
        }

        function showFloatText(tubeIdx, text, color="#38bdf8"){
            const el = ui('tubes-container').children[tubeIdx];
            if(!el) return;
            const rect = el.getBoundingClientRect();
            const float = document.createElement('div');
            float.textContent = text;
            float.style.position = 'fixed';
            float.style.left = rect.left + 'px';
            float.style.top = rect.top + 'px';
            float.style.color = color;
            float.style.fontWeight = 'bold';
            float.style.fontSize = '14px';
            float.style.pointerEvents = 'none';
            float.style.zIndex = 100;
            float.style.textShadow = '0 2px 4px rgba(0,0,0,0.8)';
            float.animate([
                { transform: 'translateY(0)', opacity: 1 },
                { transform: 'translateY(-30px)', opacity: 0 }
            ], { duration: 1000, easing: 'ease-out' });
            document.body.appendChild(float);
            setTimeout(()=>float.remove(), 1000);
        }

        function tubeCenterEl(idx){
            return ui('tubes-container').querySelector(`[data-idx="${idx}"]`);
        }

        function animatePour(fromIdx, toIdx, colorKey, count){
            return new Promise((resolve) => {
                const fromEl = tubeCenterEl(fromIdx);
                const toEl = tubeCenterEl(toIdx);
                if (!fromEl || !toEl){ resolve(); return; }
                
                const fromWater = fromEl.querySelector('.water-container');
                const toWater = toEl.querySelector('.water-container');
                
                // æ³¨ãå´: DOMã®æœ«å°¾ã‹ã‚‰countå€‹ã‚’å–å¾— (column-reverseãªã®ã§æœ«å°¾ãŒä¸€ç•ªä¸Š)
                const shrinkSegments = [];
                for(let i=0; i<count; i++){
                    if(fromWater.children.length > i){
                        shrinkSegments.push(fromWater.children[fromWater.children.length - 1 - i]);
                    }
                }
                
                // æ³¨ãŒã‚Œã‚‹å´: è‰²æƒ…å ±
                const colorHex = colorMeta(colorKey)?.hex || '#64748b';

                // å›è»¢æ–¹å‘
                const fr = fromEl.getBoundingClientRect();
                const tr = toEl.getBoundingClientRect();
                const isRight = tr.left > fr.left;
                
                // 1. å›è»¢é–‹å§‹
                fromEl.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                fromEl.style.transform = `translateY(-10px) rotate(${isRight ? 45 : -45}deg)`;
                fromEl.style.zIndex = 50; 
                
                // 2. å°‘ã—é…ã‚Œã¦æ¶²é¢å¤‰å‹•é–‹å§‹
                setTimeout(() => {
                    // æ¸›ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    shrinkSegments.forEach(seg => {
                        if(seg) {
                            seg.style.height = '0px';
                            seg.style.opacity = '0';
                            seg.style.borderTop = 'none'; 
                        }
                    });
                    
                    // å¢—ãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    for(let i=0; i<count; i++){
                        const newSeg = document.createElement('div');
                        newSeg.className = 'water-segment';
                        newSeg.style.backgroundColor = colorHex;
                        newSeg.style.height = '0px';
                        newSeg.style.opacity = '0.5';
                        toWater.appendChild(newSeg);
                        
                        // Reflow
                        void newSeg.offsetWidth;
                        
                        newSeg.style.height = 'var(--segment-height)';
                        newSeg.style.opacity = '1';
                    }
                }, 50);

                // 3. å®Œäº†å‡¦ç†
                setTimeout(() => {
                    fromEl.style.transform = '';
                    fromEl.style.zIndex = '';
                    resolve();
                }, 400); 
            });
        }

        // --- Event / Screens ---
        function showCompletionEvent(colorKey){
            return new Promise((resolve) => {
                const name = colorName(colorKey);
                const title = currentLang==='ja' ? `${name}ã®å®‰å®šåŒ–` : `${name} Stabilized`;
                const desc = currentLang==='ja'
                    ? `${name}ã‚’å®Œæˆã•ã›ãŸã€‚\næ·±æ·µãŒåå¿œã—ã¦ã„ã‚‹ã€‚`
                    : `You completed ${name}.\nThe abyss reacts to your achievement.`;

                const choices = buildEventChoices(colorKey);
                
                ui('event-kicker').textContent = t('eventKicker');
                ui('event-title').textContent = title;
                ui('event-desc').textContent = desc;
                eventChoices.innerHTML = '';

                choices.forEach(ch => {
                    const card = document.createElement('div');
                    card.className = 'glass-panel perk-card p-4 cursor-pointer hover:bg-white/5 border-l-4 border-l-sky-500';
                    card.innerHTML = `
                        <div class="text-[10px] text-sky-300 uppercase tracking-[0.35em] mb-1">${ch.kicker}</div>
                        <div class="text-xl font-black text-white">${ch.title}</div>
                        <div class="text-slate-400 text-xs mt-2 leading-relaxed">${ch.desc}</div>
                    `;
                    card.onclick = () => {
                        ch.apply();
                        eventScreen.classList.add('hidden');
                        eventScreen.classList.remove('flex');
                        renderHUD();
                        renderBoard();
                        resolve();
                    };
                    eventChoices.appendChild(card);
                });

                eventScreen.classList.remove('hidden');
                eventScreen.classList.add('flex');
            });
        }

        function buildEventChoices(colorKey){
            if (colorKey === 'B'){ 
                return [
                    {
                        kicker: currentLang==='ja' ? 'æ’å‡º' : 'Vent',
                        title: currentLang==='ja' ? 'åœ§åŠ› -4' : 'Pressure -4',
                        desc: currentLang==='ja' ? 'å®‰å…¨ã‚’ç¢ºä¿ã™ã‚‹' : 'Release built-up pressure.',
                        apply(){ gameState.pressure = Math.max(0, gameState.pressure-4); }
                    },
                    {
                        kicker: currentLang==='ja' ? 'çŸ¥è­˜' : 'Insight',
                        title: currentLang==='ja' ? 'ã‚¨ãƒƒã‚»ãƒ³ã‚¹ +4' : 'Essence +4',
                        desc: currentLang==='ja' ? 'ãƒªã‚¹ã‚¯ã‚’å–ã£ã¦å¯Œã‚’å¾—ã‚‹' : 'Gain currency for the shop.',
                        apply(){ gameState.essence += 4; }
                    }
                ];
            }
            if (colorKey === 'R'){
                return [
                    {
                        kicker: currentLang==='ja' ? 'æ´»åŠ›' : 'Vitality',
                        title: currentLang==='ja' ? 'HP +1 / åœ§åŠ› +3' : 'HP +1 / Pressure +3',
                        desc: currentLang==='ja' ? 'å›å¾©ã™ã‚‹ãŒè² è·ãŒã‹ã‹ã‚‹' : 'Heal yourself, but strain the system.',
                        apply(){ 
                            gameState.hp += 1; // ä¸Šé™çªç ´ (Fix)
                            gameState.pressure += 3; 
                        }
                    },
                    {
                        kicker: currentLang==='ja' ? 'å¹³é™' : 'Calm',
                        title: currentLang==='ja' ? 'åœ§åŠ› -6' : 'Pressure -6',
                        desc: currentLang==='ja' ? 'å¿ƒã‚’è½ã¡ç€ã‘ã‚‹' : 'Significantly reduce pressure.',
                        apply(){ gameState.pressure = Math.max(0, gameState.pressure-6); }
                    }
                ];
            }
            return [
                {
                    kicker: currentLang==='ja' ? 'æµ„åŒ–' : 'Purify',
                    title: currentLang==='ja' ? 'åœ§åŠ› -2' : 'Pressure -2',
                    desc: currentLang==='ja' ? 'å°‘ã—è½ã¡ç€ã' : 'Minor relief.',
                    apply(){ gameState.pressure = Math.max(0, gameState.pressure-2); }
                },
                {
                    kicker: currentLang==='ja' ? 'è²ªæ¬²' : 'Greed',
                    title: currentLang==='ja' ? 'ã‚¨ãƒƒã‚»ãƒ³ã‚¹ +3 / åœ§åŠ› +1' : 'Essence +3 / Pressure +1',
                    desc: currentLang==='ja' ? 'å°ã•ãªä»£å„Ÿã§å¯Œã‚’' : 'Wealth at a cost.',
                    apply(){ gameState.essence += 3; gameState.pressure += 1; }
                }
            ];
        }

        function openPerkScreen(isDeath){
            perkScreen.classList.remove('hidden');

            ui('perk-title').textContent = isDeath ? t('gameOver') : t('victory');
            ui('perk-subtitle').textContent = isDeath ? t('gameOverSub') : t('victorySub');
            ui('perk-essence').textContent = `Essence: ${gameState.essence} âœ¨`;

            // Reset contents
            perkCards.innerHTML = '';
            shopCards.innerHTML = '';
            
            if(isDeath){
                perkCards.innerHTML = `<div class="text-slate-500 text-sm">No mutations acquired.</div>`; 
                shopCards.innerHTML = `
                    <div class="col-span-full text-center py-10">
                        <p class="text-slate-400 mb-6 font-bold text-xl">Floor Reached: ${gameState.floor}</p>
                        <button onclick="startNewRun()" class="px-8 py-4 bg-rose-600 rounded-xl font-black text-white uppercase tracking-widest hover:bg-rose-500 shadow-lg shadow-rose-900/40 transform transition hover:-translate-y-1">Try Again</button>
                    </div>
                `;
                continueBtn.style.display = 'none';
                return;
            }

            continueBtn.style.display = 'block';
            continueBtn.textContent = t('continue');
            continueBtn.onclick = () => {
                perkScreen.classList.add('hidden');
                nextFloor();
            };

            if (!gameState.currentPerkChoices) {
                gameState.currentPerkChoices = rollPerkChoices();
            }
            gameState.currentPerkChoices.forEach(p => perkCards.appendChild(buildPerkCard(p)));
            
            if (!gameState.currentShopOffers) {
                gameState.currentShopOffers = rollShopOffers();
            }
            refreshRerollUI();

            gameState.currentShopOffers.forEach(item => shopCards.appendChild(buildShopCard(item)));
        }

        function rollPerkChoices(){
            const all = Object.values(PERKS);
            const candidates = all.filter(p => !gameState.perks.has(p.id));
            const basePool = candidates.length ? candidates : all;

            const floor = gameState.floor || 1;
            const boost = clamp((floor - 1) / 12, 0, 1); // æ·±å±¤ã»ã©Rare/Epicã»ã‚“ã®å°‘ã—å¢—
            let wC = 0.70 - 0.12 * boost;
            let wR = 0.25 + 0.08 * boost;
            let wE = 0.05 + 0.04 * boost;
            const sum = wC + wR + wE;
            wC /= sum; wR /= sum; wE /= sum;

            function pickByRarity(pool){
                const r = Math.random();
                let rar = 'common';
                if(r < wE) rar = 'epic';
                else if(r < wE + wR) rar = 'rare';

                const bucket = pool.filter(p => p.rarity === rar);
                return bucket.length ? pick(bucket) : pick(pool);
            }

            const picks = [];
            let pool = [...basePool];

            // æœ€ä½1æ Commonä¿è¨¼ï¼ˆå¯èƒ½ãªã‚‰ï¼‰
            const commons = pool.filter(p => p.rarity === 'common');
            if(commons.length){
                const p0 = pick(commons);
                picks.push(p0);
                pool = pool.filter(p => p.id !== p0.id);
            }

            while(picks.length < 3 && pool.length){
                const p = pickByRarity(pool);
                picks.push(p);
                pool = pool.filter(x => x.id !== p.id);
            }

            while(picks.length < 3){
                picks.push(pick(all));
            }
            return picks.slice(0,3);
        }function buildPerkCard(perk){
            const card = document.createElement('div');
            card.className = `perk-card glass-panel p-3 cursor-pointer rarity-${perk.rarity} relative hover:bg-white/5 transition-all`;
            const name = currentLang==='ja' ? perk.name.ja : perk.name.en;
            const desc = currentLang==='ja' ? perk.desc.ja : perk.desc.en;
            const owned = gameState.perks.has(perk.id);
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[9px] text-slate-400 uppercase tracking-widest">${perk.rarity}</span>
                    ${owned ? '<span class="text-[9px] text-sky-400 font-bold uppercase">OWNED</span>' : ''}
                </div>
                <div class="text-sm font-black text-white leading-tight mb-1">${name}</div>
                <div class="text-slate-400 text-[10px] leading-relaxed">${desc}</div>
                ${!owned ? '<div class="absolute bottom-2 right-2 text-white/10 text-xl font-bold">+</div>' : ''}
            `;

            if(!owned){
                card.onclick = () => {
                    acquirePerk(perk.id);
                    // é¸æŠæ¸ˆã¿ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    Array.from(perkCards.children).forEach(c => {
                        c.style.pointerEvents = 'none';
                        c.style.opacity = '0.4';
                        c.classList.remove('border-sky-500');
                    });
                    card.style.opacity = '1';
                    card.style.borderColor = '#38bdf8';
                    card.classList.add('bg-sky-500/10');
                };
            } else {
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
            }
            return card;
        }

        function buildShopCard(item){
            const card = document.createElement('div');
            card.className = 'glass-panel p-3 flex flex-col justify-between relative group hover:border-white/20 transition-all';
            
            const def = item.type==='item' ? item.ref : item;
            
            const name = currentLang==='ja' ? def.name.ja : def.name.en;
            const desc = currentLang==='ja' ? def.desc.ja : def.desc.en;
            let cost = item.cost || def.cost;
            
            // Perk: Bargain
            if(gameState.perks.has('bargain')) cost = Math.floor(cost * 0.8);
            
            const canBuy = gameState.essence >= cost;
            
            let ownedText = '';
            if(item.type==='item' && def.type==='consumable'){
                 const count = gameState.inventory[def.id] || 0;
                 if(count > 0) ownedText = `x${count}`;
            }

            // Compact Shop Card Layout
            card.innerHTML = `
                <div>
                    <div class="flex items-start justify-between mb-1">
                        <div class="text-xs font-black text-white truncate pr-1">${name}</div>
                        <div class="text-sky-300 text-[10px] font-bold whitespace-nowrap">${cost}âœ¨</div>
                    </div>
                    <div class="text-slate-500 text-[9px] leading-tight h-8 overflow-hidden">${desc}</div>
                </div>
                <button class="mt-2 w-full py-1.5 bg-white/5 rounded font-bold text-[10px] uppercase tracking-widest transition-all ${canBuy ? 'hover:bg-sky-500 hover:text-white' : 'opacity-30 cursor-not-allowed'} flex items-center justify-center gap-1">
                    <span>BUY</span>
                    ${ownedText ? `<span class="bg-black/40 px-1 rounded text-white/70">${ownedText}</span>` : ''}
                </button>
            `;
            
            const btn = card.querySelector('button');
            if(canBuy){
                btn.onclick = () => {
                    if(item.type === 'item' && def.type==='tool' && gameState.inventory[def.id]){
                        // One time tool
                        return;
                    }
                
                    gameState.essence -= cost;
                    
                    if(item.type === 'item'){
                        const id = def.id;
                        if(!gameState.inventory[id]) gameState.inventory[id] = 0;
                        if(def.type === 'tool') gameState.inventory[id] = 1;
                        else gameState.inventory[id]++;
                        
                        showToast(currentLang==='ja'?`${name}ã‚’è³¼å…¥ï¼`:`Bought ${name}!`, 'sky');
                    } else {
                        item.apply(gameState);
                    }
                    
                    // Update Essence UI
                    ui('perk-essence').textContent = `Essence: ${gameState.essence} âœ¨`;
                    ui('ui-essence').textContent = `${gameState.essence} âœ¨`;
                    
                    // Residue Refund (first purchase per floor)
                    if(gameState.perks.has('residue_refund') && !gameState.residueRefundUsedThisFloor){
                        gameState.essence += 1;
                        gameState.residueRefundUsedThisFloor = true;
                        showToast(currentLang==='ja'?'è¿”é‡‘ï¼š+1âœ¨':'Refund: +1âœ¨', 'emerald');
                    }

                    // Update Essence UI
                    ui('perk-essence').textContent = `Essence: ${gameState.essence} âœ¨`;
                    ui('ui-essence').textContent = `${gameState.essence} âœ¨`;

                    // Re-render shop: keep same 8 offers
                    shopCards.innerHTML = '';
                    (gameState.currentShopOffers || []).forEach(i => shopCards.appendChild(buildShopCard(i)));

                    refreshRerollUI();};
            }
            return card;
        }

        function acquirePerk(id){
            gameState.perks.add(id);

            if(id === 'unseal') gameState.unsealActive = true;
            if(id === 'reflux') gameState.refluxArmed = true;

            // Immediate perk effects
            if(id === 'overflow') {
                gameState.pressureMax += 4;
            }
            if(id === 'deep_reservoir'){
                gameState.pressureMax += 6;
            }
            if(id === 'fine_instruments'){
                if(!gameState.inventory.pipette) gameState.inventory.pipette = 1;
                showToast(currentLang==='ja'?'ãƒ”ãƒšãƒƒãƒˆã‚’ç²å¾—ï¼':'Pipette acquired!', 'sky');
            }
            if(id === 'reroll_savant'){
                // Enable a free reroll immediately on this perk screen as well
                gameState.freeRerollThisFloor = true;
                refreshRerollUI();
            }

            renderHUD();
        }

        // --- Core Loop ---
        function startNewRun(){
            startScreen.classList.add('hidden');
            gameState.floor = 1;
            gameState.essence = 0;
            gameState.hp = 3;
            gameState.maxHp = 3;
            gameState.perks = new Set();
            gameState.pressure = 0;
            gameState.pressureMax = 14;
            gameState.history = [];
            gameState.inventory = {};
            gameState.blackWard = 0;
            gameState.rerollCoupons = 0;
            gameState.currentShopOffers = null;
            gameState.residueRefundUsedThisFloor = false;
            gameState.laminarUsedThisFloor = false;
            gameState.freeRerollThisFloor = false; 
            gameState.unsealActive = false;
            gameState.refluxArmed = false;
            gameState.momentumActive = false;
            gameState.currentPerkChoices = null; 
            gameState.pipetteMode = false;
            gameState.targetMode = null;
            
            perkScreen.classList.add('hidden'); 
            nextFloor(true);
        }

        function nextFloor(isFirst=false){
            if(!isFirst) gameState.floor += 1;
            
            // --- Capacity Progression Logic ---
            // Floor 1-3: Cap 4
            // Floor 4-7: Cap 5
            // Floor 8+: Cap 6 (Max)
            if (gameState.floor >= 8) gameState.capacity = 6;
            else if (gameState.floor >= 4) gameState.capacity = 5;
            else gameState.capacity = 4;
            // --- Floor start flags / shop offers ---
            gameState.currentShopOffers = null;
            gameState.residueRefundUsedThisFloor = false;
            gameState.laminarUsedThisFloor = false;
            gameState.freeRerollThisFloor = gameState.perks.has('reroll_savant');

            // Perk: Wardweaver (Black Ward)
            if(gameState.perks.has('wardweaver')){
                gameState.blackWard = (gameState.blackWard||0) + 1;
                showToast(currentLang==='ja'?'ãƒ–ãƒ©ãƒƒã‚¯ãƒ¯ãƒ¼ãƒ‰ +1':'Black Ward +1', 'purple');
            }

            // Perk: Abyssal Patron
            if(gameState.perks.has('abyssal_patron')){
                gameState.essence += 2;
                showToast(currentLang==='ja'?'å¾Œæ´ï¼š+2âœ¨':'Patron: +2âœ¨', 'emerald');
            }

            // Perk: Scavenger logic
            if(!isFirst && gameState.perks.has('scavenger')){
                if(Math.random() < 0.15){
                    const items = ['inverter', 'void_salt', 'separator', 'cycle_siphon', 'micro_siphon', 'top_swapper', 'black_magnet']; 
                    const gift = pick(items);
                    if(!gameState.inventory[gift]) gameState.inventory[gift] = 0;
                    gameState.inventory[gift]++;
                    // alert("Scavenger found: " + ITEMS[gift].name[currentLang==='ja'?'ja':'en']);
                    showToast("Scavenger found: " + ITEMS[gift].name[currentLang==='ja'?'ja':'en'], 'emerald');
                }
            }
            
            // Perk: Prime Scavenger logic
            if(!isFirst && gameState.perks.has('prime_scavenger')){
                if(Math.random() < 0.20){
                    const items = ['inverter', 'void_salt', 'separator', 'cycle_siphon', 'micro_siphon', 'top_swapper', 'black_magnet'];
                    const gift = pick(items);
                    if(!gameState.inventory[gift]) gameState.inventory[gift] = 0;
                    gameState.inventory[gift]++;
                    showToast("Prime found: " + ITEMS[gift].name[currentLang==='ja'?'ja':'en'], 'emerald');
                }
            }

            // Perk: Transmutation Logic (NEW)
            if(!isFirst && gameState.perks.has('transmutation')){
                const items = ['inverter', 'void_salt', 'separator', 'cycle_siphon', 'micro_siphon', 'top_swapper', 'black_magnet']; 
                const gift = pick(items);
                if(!gameState.inventory[gift]) gameState.inventory[gift] = 0;
                gameState.inventory[gift]++;
                showToast("Transmutation: Created " + ITEMS[gift].name[currentLang==='ja'?'ja':'en'], 'purple');
            }
            
            // Perk: Deep Adapt Logic
            if(gameState.perks.has('deep_adapt')){
                // Gain +1 Max HP if capacity > 4
                if(gameState.capacity > 4){
                    gameState.maxHp += 1;
                    gameState.hp += 1; // Heal as well?
                }
            }

            gameState.movesPerFloor = 0; // Unused
            gameState.turnCount = 0;
            gameState.pressure = 0; 
            gameState.catalystAvailable = true;
            if(gameState.perks.has('reflux')) gameState.refluxArmed = true;

            generateBoard();
            generateGoals();
            
            gameState.currentPerkChoices = null;
            gameState.selectedIdx = null;
            gameState.busy = false;
            gameState.targetMode = null;
            gameState.pipetteMode = false;
            gameState.momentumActive = false;
            
            renderHUD();
            renderBoard();
        }

        function tryUndo(){
            if (!gameState.history.length) return;
            
            let cost = 5; 
            let isFree = false;
            
            if(gameState.refluxArmed){
                isFree = true;
            } else if (gameState.essence < cost){
                ui('ui-essence').classList.add('text-red-500');
                setTimeout(()=>ui('ui-essence').classList.remove('text-red-500'), 500);
                return;
            }

            const prev = gameState.history.pop();
            gameState.tubes = prev.tubes;
            gameState.turnCount = prev.turnCount;
            gameState.pressure = prev.pressure;
            gameState.hp = prev.hp;
            gameState.secondaryProgress = prev.secondaryProgress;
            gameState.catalystAvailable = prev.catalystAvailable;
            gameState.essence = prev.essence;
            gameState.inventory = prev.inventory; 
            gameState.blackWard = prev.blackWard || 0;
            gameState.rerollCoupons = prev.rerollCoupons || 0;
            gameState.residueRefundUsedThisFloor = !!prev.residueRefundUsedThisFloor;
            gameState.laminarUsedThisFloor = !!prev.laminarUsedThisFloor;
            gameState.freeRerollThisFloor = !!prev.freeRerollThisFloor;
            gameState.tubeCount = prev.tubeCount;
            gameState.capacity = prev.capacity || 4; // Restore capacity
            gameState.momentumActive = prev.momentumActive;
            
            if(isFree){
                gameState.pressure += 2;
                gameState.refluxArmed = false;
                showFloatText(0, "Reflux Used (+2 Pressure)", "#a855f7");
            } else {
                gameState.essence -= cost;
            }

            gameState.selectedIdx = null;
            updateTubeLayout();
            renderHUD();
            renderBoard();
        }

        // --- HUD ---
        function renderHUD(){
            setText('ui-floor', `${t('floor')} ${gameState.floor}`);
            setText('ui-essence', `${gameState.essence} âœ¨`);
            setText('ui-hp', `HP ${gameState.hp}`);
            
            setText('ui-essence-mobile', `${gameState.essence} âœ¨`);
            setText('ui-hp-mobile', `HP ${gameState.hp}`);

            setText('ui-turn', `${t('turn')} ${gameState.turnCount}`);
            setText('ui-perks', `${t('perks')} ${gameState.perks.size}`);

            setText('ui-goal', gameState.primaryGoal?.text ?? 'â€”');
            setText('ui-goal-sub', gameState.secondaryGoal?.text ?? 'â€”');
            
            setText('ui-secondary', `${t('secondary')} ${secondarySucceeded() ? 'COMPLETE' : 'â€”'}`);
            
            const secondaryEl = ui('ui-secondary');
            if (secondaryEl) {
                secondaryEl.className = secondarySucceeded() 
                    ? "px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest bg-emerald-500/20 text-emerald-300 border border-emerald-500/50"
                    : "px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest bg-black/20";
            }

            setText('ui-pressure', String(gameState.pressure));
            const pct = Math.round((gameState.pressure / gameState.pressureMax) * 100);
            
            const pBar = ui('ui-pressure-bar');
            if(pBar) {
                pBar.style.width = `${clamp(pct,0,100)}%`;
                 if(gameState.pressure >= gameState.pressureMax - 3){
                    pBar.classList.remove('from-sky-400', 'via-purple-400');
                    pBar.classList.add('bg-rose-600');
                } else {
                    pBar.classList.add('from-sky-400', 'via-purple-400');
                    pBar.classList.remove('bg-rose-600');
                }
            }
            setText('ui-pressure-sub', `${gameState.pressure} / ${gameState.pressureMax}`);
           
            
            // Undoãƒœã‚¿ãƒ³ã®æ›´æ–°
            const undoCost = gameState.refluxArmed ? 'FREE' : '5âœ¨';
            if (undoBtn) {
                undoBtn.innerHTML = `<span>â†º</span> UNDO (${undoCost})`;
                if(!gameState.refluxArmed && gameState.essence < 5 && gameState.history.length > 0){
                    undoBtn.style.opacity = '0.5';
                    undoBtn.style.cursor = 'not-allowed';
                } else if (gameState.history.length === 0){
                    undoBtn.style.opacity = '0.3';
                    undoBtn.style.cursor = 'default';
                } else {
                    undoBtn.style.opacity = '1';
                    undoBtn.style.cursor = 'pointer';
                }
            }

            renderSkills();
        }

        function moveFocus(dx){
            if(!gameState.tubes.length) return;
            const n = gameState.tubeCount;
            
            // ã‚­ãƒ¼æ“ä½œæ™‚ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒãªã‘ã‚Œã°0ç•ªç›®ã‚’é¸æŠã—ã¦è¡¨ç¤ºé–‹å§‹
            if (gameState.focusIdx === null) {
                gameState.focusIdx = 0;
            } else {
                gameState.focusIdx = (gameState.focusIdx + dx + n) % n;
            }
            renderBoard();
        }

        ui('btn-help').onclick = () => ui('help-screen').classList.replace('hidden', 'flex');
        ui('help-close').onclick = () => ui('help-screen').classList.replace('flex', 'hidden');
        ui('btn-settings').onclick = () => ui('settings-screen').classList.replace('hidden', 'flex');
        ui('settings-close').onclick = () => ui('settings-screen').classList.replace('flex', 'hidden');
        if(undoBtn) undoBtn.onclick = () => tryUndo();
        
        ui('reroll-btn').onclick = () => {
            const meta = getRerollMeta();
            if(!meta.can) return;

            if(gameState.freeRerollThisFloor){
                gameState.freeRerollThisFloor = false;
                showToast(currentLang==='ja'?'ç„¡æ–™ãƒªãƒ­ãƒ¼ãƒ«ï¼':'Free reroll!', 'emerald');
            } else if((gameState.rerollCoupons||0) > 0){
                gameState.rerollCoupons--;
                showToast(currentLang==='ja'?'ã‚¯ãƒ¼ãƒãƒ³ã‚’ä½¿ç”¨ï¼':'Coupon used!', 'emerald');
            } else if(gameState.essence >= 5){
                gameState.essence -= 5;
            } else {
                return;
            }

            gameState.currentPerkChoices = null;
            gameState.currentShopOffers = null;

            openPerkScreen(false);
            ui('perk-essence').textContent = `Essence: ${gameState.essence} âœ¨`;
            refreshRerollUI();
        };

        ui('toggle-tests').onchange = (e) => {
            devTests.style.display = e.target.checked ? 'block' : 'none';
        };
        
        ui('start-run-btn').onclick = startNewRun;

        window.onkeydown = (e) => {
            if(!perkScreen.classList.contains('hidden')) return;
            if(!eventScreen.classList.contains('hidden')) return;
            if(!helpScreen.classList.contains('hidden')) return;

            if (e.key === 'ArrowLeft') moveFocus(-1);
            if (e.key === 'ArrowRight') moveFocus(1);
            
            if (e.key === 'Enter' || e.key === ' ') {
                 if(gameState.focusIdx !== null) handleTubeClick(gameState.focusIdx);
            }
            if (e.key === 'Backspace' || e.key === 'z') tryUndo();
        };

        applyLang();
        
    </script>
</body>
</html>