<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abyssal Alchemy - Water Sort Rogue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #020617;
            --tube-border: #334155;
            --tube-bg: rgba(15, 23, 42, 0.4);
            --pour-speed: 0.3s;
            --segment-height: 40px; /* JS„ÅßÂãïÁöÑ„Å´Â§âÊõ¥„Åï„Çå„Åæ„Åô */
            --tube-height: 220px;   /* JS„ÅßÂãïÁöÑ„Å´Â§âÊõ¥„Åï„Çå„Åæ„Åô */
            --primary-glow: #38bdf8;
            --rarity-common: #94a3b8;
            --rarity-rare: #3b82f6;
            --rarity-epic: #a855f7;
        }

        body {
            background: radial-gradient(circle at 50% 0%, #0f172a 0%, #020617 100%);
            color: white;
            font-family: 'Inter', system-ui, sans-serif;
            touch-action: manipulation;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            user-select: none;
            -webkit-user-select: none;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* „ÉÅ„É•„Éº„Éñ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .tube {
            width: clamp(40px, 10vw, 56px);
            height: var(--tube-height);
            border: 3px solid var(--tube-border);
            border-top: 2px solid rgba(255,255,255,0.15);
            border-bottom-left-radius: 28px;
            border-bottom-right-radius: 28px;
            position: relative;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s ease, border-color 0.3s ease;
            background: var(--tube-bg);
            margin: 6px; /* „Éû„Éº„Ç∏„É≥„ÇíÂ∞ë„ÅóË©∞„ÇÅ„Çã */
            z-index: 10;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            box-shadow: inset 2px 0 4px rgba(255,255,255,0.05), inset -2px 0 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .tube.selected {
            transform: translateY(-15px) scale(1.05);
            border-color: var(--primary-glow);
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.25);
            z-index: 20;
        }
        
        .tube.target-mode {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
            animation: pulse-purple 1.5s infinite;
        }

        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 30px rgba(168, 85, 247, 0.7); }
        }

        .tube-focused {
            border-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.3); /* „Éï„Ç©„Éº„Ç´„Çπ„ÇíÂ∞ë„ÅóÂº∑Ë™ø */
        }

        /* Ë©∞„ÅøË≠¶Âëä */
        .deadlock-glow {
            box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.5) !important;
            border-color: rgba(244, 63, 94, 0.8) !important;
        }

        .water-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column-reverse;
            padding: 0;
            gap: 0;
            pointer-events: none;
            width: 100%;
        }

        .water-segment {
            width: 100%;
            height: var(--segment-height);
            position: relative;
            transition: height 0.3s ease, opacity 0.3s ease;
        }

        .water-segment::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.1) 0%, 
                rgba(255,255,255,0) 20%, 
                rgba(0,0,0,0.1) 50%, 
                rgba(255,255,255,0) 80%, 
                rgba(255,255,255,0.15) 100%);
            opacity: 0.6;
        }

        .water-segment:last-child {
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        .water-segment:last-child::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255,255,255,0.4);
            filter: blur(2px);
            border-radius: 50%;
            transform: scaleX(0.9);
        }
        
        /* Ëí∏Áô∫„Ç®„Éï„Çß„ÇØ„Éà */
        @keyframes evaporate {
            0% { transform: scale(1); opacity: 1; filter: brightness(1); }
            50% { filter: brightness(2); background-color: white; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .evaporating .water-segment {
            animation: evaporate 0.6s forwards;
        }

        /* Ë®ÄË™û„Éú„Çø„É≥ */
        .lang-btn{
            padding: 6px 10px;
            font-weight: 800;
            font-size: 12px;
            border-radius: 12px;
            opacity: 0.55;
            transition: all .2s;
        }
        .lang-btn.active{ opacity: 1; background: rgba(56,189,248,0.15); border: 1px solid rgba(56,189,248,0.35); }

        /* Â§âÁï∞„Ç´„Éº„Éâ */
        .perk-card {
            transition: all 0.25s ease;
            border: 1px solid rgba(255,255,255,0.06);
            position: relative;
            overflow: hidden;
        }
        .perk-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border-color: rgba(56,189,248,0.35);
        }

        /* „É¨„Ç¢„É™„ÉÜ„Ç£ */
        .rarity-common{ border-left: 3px solid var(--rarity-common); }
        .rarity-rare{ border-left: 3px solid var(--rarity-rare); }
        .rarity-epic{ border-left: 3px solid var(--rarity-epic); }
        
        /* „Çπ„Ç≠„É´„Éú„Çø„É≥ & „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
        .skill-btn {
            position: relative;
            transition: all 0.2s;
            filter: grayscale(0.8);
            opacity: 0.7;
        }
        .skill-btn:not(:disabled):hover {
            filter: grayscale(0);
            opacity: 1;
            transform: translateY(-2px);
            z-index: 50; /* „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË°®Á§∫ÊôÇ„Å´ÊâãÂâç„Å´ */
        }
        .skill-btn.active {
            filter: grayscale(0);
            opacity: 1;
            border-color: var(--primary-glow);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
            background: rgba(56, 189, 248, 0.2);
        }
        .skill-btn.active-mode {
            filter: grayscale(0);
            opacity: 1;
            border-color: #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
            background: rgba(168, 85, 247, 0.2);
            animation: pulse-btn 1.5s infinite;
        }
        @keyframes pulse-btn {
            0% { box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.8); }
            100% { box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }
        }

        /* „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Çπ„Çø„Ç§„É´ */
        .skill-tooltip {
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(2, 6, 23, 0.95);
            border: 1px solid rgba(56, 189, 248, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            width: max-content;
            max-width: 220px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }
        .skill-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(56, 189, 248, 0.3) transparent transparent transparent;
        }
        .skill-btn:hover .skill-tooltip {
            opacity: 1;
            visibility: visible;
            bottom: 125%;
        }

        /* UNDO„Éú„Çø„É≥ */
        #btn-undo {
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            transition: all 0.2s;
        }
        #btn-undo:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }
        #btn-undo:active {
            transform: scale(0.95);
        }

        /* Ë≠¶Âëä„Éê„Éä„Éº */
        #alert-banner {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(244, 63, 94, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* „Éà„Éº„Çπ„ÉàÈÄöÁü• */
        #toast-container {
            pointer-events: none;
        }
        .toast-msg {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(56, 189, 248, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            animation: toast-in 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(4px);
        }
        .toast-msg.fade-out {
            animation: toast-out 0.3s forwards;
        }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(-20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toast-out {
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* ÊµÆÈÅä */
        .floating{
            animation: floaty 3.2s ease-in-out infinite;
        }
        @keyframes floaty{
            0%,100%{ transform: translateY(0); }
            50%{ transform: translateY(-10px); }
        }

        /* „Çπ„Ç±„Éº„É™„É≥„Ç∞Áî®„Ç≥„É≥„ÉÜ„Éä„Çπ„Çø„Ç§„É´ */
        #tubes-container {
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-origin: center center;
            /* ÂøÖË¶Å„Å™„Çâ„Åì„Åì„Å´max-width„Å™„Å©„ÅÆÂà∂Èôê„ÇíËøΩÂä† */
        }

        /* „ÉÜ„Çπ„ÉàË°®Á§∫ */
        #dev-tests {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 999;
            font-family: ui-monospace, Menlo, Consolas, monospace;
            font-size: 11px;
            color: rgba(255,255,255,0.75);
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 8px 10px;
            border-radius: 8px;
            max-width: min(560px, 92vw);
            white-space: pre-wrap;
            display:none;
        }
    </style>
</head>
<body>
    
    <!-- „Éà„Éº„Çπ„ÉàÈÄöÁü•„Ç≥„É≥„ÉÜ„Éä -->
    <div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[200] flex flex-col gap-2 w-full max-w-sm px-4"></div>

    <div id="game-container" class="flex flex-col items-center justify-between h-screen w-screen p-2 md:p-4 overflow-hidden relative">
        <div id="alert-banner">NO MOVES LEFT</div>

        <!-- „Éà„ÉÉ„ÉóHUD -->
        <div id="top-hud" class="w-full max-w-5xl glass-panel p-3 md:p-4 flex items-center justify-between z-20 shrink-0 mb-2">
            <div class="flex items-center gap-4">
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]" id="ui-subtitle">Èå¨ÈáëË°ì„ÅÆÊ∑±Ê∑µ</div>
                    <div class="text-xl md:text-2xl font-black tracking-tight leading-none bg-gradient-to-br from-white to-slate-400 bg-clip-text text-transparent" id="ui-title">Abyssal Alchemy</div>
                </div>
                <div class="hidden md:flex items-center gap-3 ml-4">
                    <span class="px-4 py-2 rounded-xl glass-panel text-xl font-bold border border-white/5" id="ui-floor">FLOOR 1</span>
                    <span class="px-4 py-2 rounded-xl glass-panel text-xl font-bold text-sky-300 border border-white/5" id="ui-essence">0 ‚ú®</span>
                    <span class="px-4 py-2 rounded-xl glass-panel text-xl font-bold text-rose-300 border border-white/5" id="ui-hp">HP 3</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button id="btn-help" class="w-10 h-10 md:w-auto md:h-auto md:px-4 md:py-2 flex items-center justify-center glass-panel font-bold text-xs uppercase tracking-widest hover:bg-white/5 active:scale-95 transition-all">
                    <span class="md:hidden">?</span><span class="hidden md:inline">Help</span>
                </button>
                <button id="btn-settings" class="w-10 h-10 md:w-auto md:h-auto md:px-4 md:py-2 flex items-center justify-center glass-panel font-bold text-xs uppercase tracking-widest hover:bg-white/5 active:scale-95 transition-all">‚öô</button>
            </div>
        </div>

        <!-- ÁõÆÊ®ô/ÂúßÂäõ Ë°å -->
        <div id="status-bar" class="w-full max-w-5xl flex gap-2 shrink-0 z-20 mb-2">
            <div class="flex-1 glass-panel px-4 py-2 border-l-4 border-l-sky-500/50">
                <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]" id="ui-goal-title">GOAL</div>
                <div class="text-sm font-black tracking-tight text-white" id="ui-goal">‚Äî</div>
                <div class="text-[10px] text-slate-500 mt-1" id="ui-goal-sub">‚Äî</div>
            </div>
            <div class="w-[180px] md:w-[220px] glass-panel px-4 py-2 border-l-4 border-l-rose-500/50">
                <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]">PRESSURE</div>
                <div class="flex items-center gap-2 mt-1">
                    <div class="flex-1 h-2 rounded-full bg-slate-800/80 overflow-hidden relative border border-white/5">
                        <div id="ui-pressure-bar" class="h-full rounded-full bg-gradient-to-r from-sky-400 via-purple-400 to-rose-500 transition-all duration-300" style="width:0%"></div>
                    </div>
                    <div class="text-xs font-black w-5 text-right" id="ui-pressure">0</div>
                </div>
                <div class="text-[10px] text-slate-500 mt-1 text-right" id="ui-pressure-sub">‚Äî</div>
            </div>
        </div>

        <!-- Áõ§Èù¢„Ç®„É™„Ç¢ -->
        <!-- overflow-hidden „ÇíËøΩÂä†„Åó„ÄÅÂÜÖÈÉ®„ÅÆtubes-container„Åå„ÅØ„ÅøÂá∫„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã -->
        <div id="board-area" class="flex-1 w-full flex items-center justify-center relative z-10 overflow-hidden my-2">
            <div id="tubes-container" class="flex flex-wrap items-center justify-center content-center max-w-5xl"></div>
        </div>
        
        <!-- „Çπ„Ç≠„É´„Éê„Éº -->
        <div id="skills-container" class="w-full max-w-lg flex justify-center gap-3 z-20 mb-2 min-h-[50px] shrink-0">
            <!-- JS„Åß„Éú„Çø„É≥ÁîüÊàê -->
        </div>

        <!-- ‰∏ãHUD -->
        <div id="bottom-hud" class="w-full max-w-5xl glass-panel p-3 md:p-4 shrink-0 z-20 mb-safe">
            <div class="md:hidden flex justify-between mb-3 px-1">
                 <span class="text-lg font-bold text-sky-300" id="ui-essence-mobile">0 ‚ú®</span>
                 <span class="text-lg font-bold text-rose-300" id="ui-hp-mobile">HP 3</span>
            </div>
            <div class="flex items-center justify-between gap-3 relative">
                <div class="flex items-center gap-2 md:gap-3 flex-wrap">
                    <span class="px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest bg-black/20" id="ui-turn">TURN 0</span>
                    <span class="px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest bg-black/20" id="ui-secondary">BONUS ‚Äî</span>
                    <span class="px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest text-sky-300 bg-black/20 hidden sm:block" id="ui-perks">PERKS 0</span>
                </div>
                
                <!-- „Éí„É≥„ÉàË¶ÅÁ¥†ÂâäÈô§ -->

                <!-- UNDO„Éú„Çø„É≥ -->
                <button id="btn-undo" class="px-4 py-2 rounded-xl font-bold text-xs uppercase tracking-widest text-slate-300 flex items-center gap-2">
                    <span>‚Ü∫</span> UNDO (5‚ú®)
                </button>
            </div>
        </div>

    </div>

    <!-- ÁîªÈù¢Ôºö„Ç§„Éô„É≥„ÉàÔºàÂÆåÊàê2ÊäûÔºâ -->
    <div id="event-screen" class="fixed inset-0 z-[140] bg-slate-950/85 backdrop-blur-sm hidden items-center justify-center p-6 transition-opacity">
        <div class="glass-panel w-full max-w-2xl p-6 border border-sky-500/20 shadow-2xl shadow-sky-900/20">
            <div class="flex items-end justify-between gap-4">
                <div>
                    <div class="text-[10px] text-sky-400 uppercase tracking-[0.35em] font-bold" id="event-kicker">EVENT</div>
                    <div class="text-3xl font-black tracking-tight text-white mt-1" id="event-title">‚Äî</div>
                    <div class="text-slate-300 text-sm mt-3 whitespace-pre-line leading-relaxed" id="event-desc">‚Äî</div>
                </div>
                <div class="text-right shrink-0">
                    <div class="px-3 py-1 bg-rose-500/10 border border-rose-500/30 rounded text-[10px] text-rose-300 uppercase tracking-[0.2em]">Unavoidable</div>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mt-8" id="event-choices"></div>
        </div>
    </div>

    <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
    <div id="start-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-950 p-8">
        <div class="absolute top-8 right-8 flex gap-2 glass-panel p-1 z-50">
            <button onclick="setLang('en')" id="lang-en" class="lang-btn">EN</button>
            <button onclick="setLang('ja')" id="lang-ja" class="lang-btn active">JP</button>
        </div>

        <div class="text-center mb-16 floating relative">
            <div class="absolute inset-0 bg-sky-500/20 blur-[100px] rounded-full"></div>
            <h1 class="relative text-5xl md:text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-sky-300 via-sky-500 to-indigo-600 drop-shadow-2xl leading-tight">ABYSSAL<br>ALCHEMY</h1>
            <p id="start-subtitle" class="relative text-sky-200/60 font-medium tracking-[0.5em] uppercase text-xs mt-4">Èå¨ÈáëË°ì„ÅÆÊ∑±Ê∑µ</p>
        </div>
        <button id="start-run-btn" class="w-full max-w-xs py-5 bg-sky-600 rounded-2xl font-black text-white uppercase tracking-widest shadow-2xl shadow-sky-500/20 hover:bg-sky-500 hover:shadow-sky-500/40 hover:-translate-y-1 transition-all active:scale-95 active:translate-y-0">Êé¢Á¥¢„ÇíÈñãÂßã</button>
        <p class="text-slate-600 text-[10px] mt-8 tracking-widest uppercase">Ver 1.9.3 No Hint</p>
    </div>

    <!-- Â§âÁï∞ÈÅ∏Êäû & „Ç∑„Éß„ÉÉ„ÉóÁîªÈù¢ (Layout Revised: 1-screen fit) -->
    <div id="perk-screen" class="fixed inset-0 z-[150] bg-slate-950 flex flex-col items-center justify-center p-4 md:p-8 hidden">
        <div class="w-full max-w-6xl h-full max-h-full flex flex-col glass-panel p-0 overflow-hidden relative border border-white/10 shadow-2xl shadow-black/80">
            
            <!-- Header -->
            <div class="flex justify-between items-center p-4 md:p-6 border-b border-white/5 shrink-0 bg-slate-900/40">
                <div>
                    <h2 id="perk-title" class="text-xl md:text-3xl font-black text-white italic uppercase leading-none">Â§âÁï∞„ÅÆÂÖÜ„Åó</h2>
                    <p id="perk-subtitle" class="text-slate-400 text-[10px] md:text-xs mt-1 uppercase tracking-widest">ÁÑ°Êñô„ÅÆÂº∑Âåñ„Çí1„Å§ÈÅ∏Êäû</p>
                </div>
                <div class="text-right flex flex-col items-end gap-2">
                    <button id="reroll-btn" class="px-3 py-1 glass-panel border border-white/5 text-[10px] font-black uppercase tracking-widest hover:bg-white/5 active:scale-95 transition-all hidden">Reroll (-5‚ú®)</button>
                    <!-- „Çπ„Éû„ÉõÁî®„ÅÆEssenceË°®Á§∫„ÅØ„Ç∑„Éß„ÉÉ„ÉóÂÜÖ„Å´Áµ±Âêà„Åô„Çã„Åì„Å®„ÇÇÊ§úË®é„Åó„Åü„Åå„ÄÅ„Åì„Åì„ÅåË¶ã„ÇÑ„Åô„ÅÑ -->
                </div>
            </div>

            <!-- Main Content (Split Layout) -->
            <div class="flex-1 flex flex-col md:flex-row min-h-0 overflow-hidden">
                
                <!-- Left: Perks -->
                <div class="flex-1 flex flex-col p-4 md:p-6 overflow-y-auto border-b md:border-b-0 md:border-r border-white/5 bg-slate-900/20">
                    <div class="text-sm font-bold mb-3 text-sky-300 uppercase tracking-widest flex items-center gap-2">
                        <span>üß¨ Mutations</span>
                        <span class="text-[10px] text-slate-500 font-normal normal-case">Pick One</span>
                    </div>
                    <div class="grid gap-3" id="perk-cards">
                        <!-- Perks injected here -->
                    </div>
                </div>

                <!-- Right: Shop -->
                <div class="flex-1 flex flex-col p-4 md:p-6 overflow-y-auto">
                    <div class="flex justify-between items-center mb-3">
                        <div class="text-sm font-bold text-yellow-500 uppercase tracking-widest flex items-center gap-2">
                            <span>‚óà Shop</span>
                        </div>
                        <div class="text-[10px] font-bold text-sky-400 bg-sky-900/30 px-2 py-1 rounded border border-sky-500/20" id="perk-essence">Essence: 0 ‚ú®</div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-3" id="shop-cards">
                        <!-- Shop Items injected here -->
                    </div>

                    <div class="mt-auto pt-6 flex justify-center">
                        <button id="continue-btn" class="w-full py-3 bg-indigo-600 rounded-xl font-black text-white text-sm uppercase tracking-widest shadow-lg shadow-indigo-900/40 hover:bg-indigo-500 transition-all active:scale-95">Next Floor</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Help -->
    <div id="help-screen" class="fixed inset-0 z-[160] bg-slate-950/90 backdrop-blur hidden items-center justify-center p-6">
        <div class="glass-panel w-full max-w-2xl p-8 border border-white/10">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]">HELP</div>
                    <div class="text-3xl font-black tracking-tight">Guide</div>
                </div>
                <button id="help-close" class="px-4 py-2 glass-panel font-black text-xs uppercase tracking-widest hover:bg-white/10 active:scale-95 transition-colors">Close</button>
            </div>
            <div class="text-slate-300 text-sm leading-loose whitespace-pre-line font-medium" id="help-text"></div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settings-screen" class="fixed inset-0 z-[160] bg-slate-950/90 backdrop-blur hidden items-center justify-center p-6">
        <div class="glass-panel w-full max-w-xl p-8 border border-white/10">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-[0.35em]">SETTINGS</div>
                    <div class="text-3xl font-black tracking-tight">Options</div>
                </div>
                <button id="settings-close" class="px-4 py-2 glass-panel font-black text-xs uppercase tracking-widest hover:bg-white/10 active:scale-95 transition-colors">Close</button>
            </div>
            <div class="mt-5 grid gap-4">
                <label class="glass-panel p-4 flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors">
                    <span class="text-sm font-black uppercase tracking-widest">Show Debug Info</span>
                    <input type="checkbox" id="toggle-tests" class="scale-125 accent-sky-500" />
                </label>
            </div>
        </div>
    </div>

    <div id="dev-tests"></div>

    <script>
        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
        function clamp(val, min, max){ return Math.min(Math.max(val, min), max); }
        function randInt(n){ return Math.floor(Math.random()*n); }
        function pick(arr){ return arr[randInt(arr.length)]; }
        function deepCopy(x){ return JSON.parse(JSON.stringify(x)); }
        function ui(id){ return document.getElementById(id); }
        // ÂÆâÂÖ®„Å™„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö
        function setText(id, text){
            const el = document.getElementById(id);
            if(el) el.textContent = text;
        }

        // --- „Éà„Éº„Çπ„ÉàÈÄöÁü• ---
        function showToast(msg, color='sky'){
            const container = ui('toast-container');
            const el = document.createElement('div');
            el.className = `toast-msg text-${color}-300 border-${color}-500/30`;
            el.innerHTML = `<span>‚óà</span> ${msg}`;
            container.appendChild(el);
            setTimeout(() => {
                el.classList.add('fade-out');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- ÁøªË®≥„Éá„Éº„Çø ---
        const translations = {
            en: {
                subtitle: "Abyssal Alchemy",
                startBtn: "Begin Descent",
                vitality: "HP",
                floor: "FLOOR",
                essence: "Essence",
                turn: "TURN",
                secondary: "BONUS",
                perks: "PERKS",
                hint: "Select a tube to pour",
                goalTitle: "GOAL",
                pressureTitle: "PRESSURE",
                eventKicker: "EVENT",
                unavoid: "Unavoidable",
                helpTitle: "How to play",
                helpText: [
                    "‚Ä¢ Pour water: Click a tube, then click another to pour.",
                    "‚Ä¢ Obsidian (Black Ink): Match 4 to evaporate them and clear the tube!",
                    "‚Ä¢ Pressure: Rises with every move. If it fills, you take 1 Damage.",
                    "‚Ä¢ Survival: No Move limit. Manage your HP and Pressure to survive.",
                    "‚Ä¢ Artifacts: Buy skills in the shop. Use them from the bottom bar.",
                    "‚Ä¢ Undo: Use the button below (Costs 5 Essence).",
                ].join("\n"),
                helpClose: "Close",
                settings: "Settings",
                continue: "Continue",
                shopTitle: "Shop",
                shopSub: "Trade Essence for survival",
                gameOver: "Consumed",
                gameOverSub: "The abyss claims another soul...",
                victory: "Mutation",
                victorySub: "Select a mutation to evolve",
            },
            ja: {
                subtitle: "Èå¨ÈáëË°ì„ÅÆÊ∑±Ê∑µ",
                startBtn: "Êé¢Á¥¢„ÇíÈñãÂßã",
                vitality: "HP",
                floor: "ÈöéÂ±§",
                essence: "„Ç®„ÉÉ„Çª„É≥„Çπ",
                turn: "ÁµåÈÅé„Çø„Éº„É≥",
                secondary: "ÂâØÁõÆÊ®ô",
                perks: "Â§âÁï∞",
                hint: "„ÉÅ„É•„Éº„Éñ„ÇíÈÅ∏Êäû„Åó„Å¶Ê≥®„Åê",
                goalTitle: "ÁõÆÊ®ô",
                pressureTitle: "ÂúßÂäõ",
                eventKicker: "Â§âË≥™",
                unavoid: "‰∏çÂèØÈÅø",
                helpTitle: "ÈÅä„Å≥Êñπ",
                helpText: [
                    "„ÉªÊ≥®„ÅêÔºö„ÉÅ„É•„Éº„Éñ„ÇíÈÅ∏Êäû„Åó„ÄÅÂà•„ÅÆ„ÉÅ„É•„Éº„Éñ„Å∏Ê≥®„Åé„Åæ„Åô",
                    "„ÉªÈªí„Ç§„É≥„ÇØÔºö4„Å§ÊèÉ„Åà„Çã„Å®Ëí∏Áô∫„Åó„Å¶Ê∂à„Åà„ÄÅÁ©∫„ÅçÁì∂„Å´„Å™„Çä„Åæ„Åô„ÄÇ",
                    "„ÉªÂúßÂäõÔºö1Êâã„Åî„Å®„Å´‰∏äÊòá„Åó„Åæ„Åô„ÄÇÊúÄÂ§ß„Å´„Å™„Çã„Å®HP„Åå1Ê∏õ„Çä„Åæ„Åô„ÄÇ",
                    "„ÉªÁîüÂ≠òÔºöÊâãÊï∞Âà∂Èôê„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇHP„ÅåÂ∞Ω„Åç„Å™„ÅÑÈôê„ÇäÊé¢Á¥¢„ÇíÁ∂ö„Åë„Çâ„Çå„Åæ„Åô„ÄÇ",
                    "„ÉªÈÅìÂÖ∑„Å®ÁßòË°ìÔºö„Ç∑„Éß„ÉÉ„Éó„Åß„Çπ„Ç≠„É´„ÇíË≥ºÂÖ•„Åó„ÄÅÁîªÈù¢‰∏ãÈÉ®„Åã„Çâ‰ΩøÁî®„Åó„Åæ„Åô",
                    "„Éª„ÇÑ„ÇäÁõ¥„ÅóÔºöÂè≥‰∏ã„ÅÆUNDO„Éú„Çø„É≥„Çí‰ΩøÁî®„Åó„Åæ„ÅôÔºàÊ∂àË≤ªÔºö5„Ç®„ÉÉ„Çª„É≥„ÇπÔºâ",
                ].join("\n"),
                helpClose: "Èñâ„Åò„Çã",
                settings: "Ë®≠ÂÆö",
                continue: "Ê¨°„Å∏ÈÄ≤„ÇÄ",
                shopTitle: "„Ç∑„Éß„ÉÉ„Éó",
                shopSub: "„Ç®„ÉÉ„Çª„É≥„Çπ„ÇíÊ∂àË≤ª„Åó„Å¶ÂÆâÂÆö„ÇíÂæó„Çã",
                gameOver: "Â•àËêΩ„Å´Âëë„Åæ„Çå„Åü",
                gameOverSub: "Ê∑±Ê∑µ„ÅØ„Åæ„Åü‰∏Ä„Å§È≠Ç„ÇíÂñ∞„Çâ„Å£„Åü...",
                victory: "Â§âÁï∞„ÅÆÂÖÜ„Åó",
                victorySub: "Âäõ„ÇíÈÅ∏„Çì„ÅßÈÄ≤Âåñ„Åô„Çã",
            }
        };

        let currentLang = 'ja';

        function setLang(lang){
            currentLang = lang;
            document.getElementById('lang-en').classList.toggle('active', lang==='en');
            document.getElementById('lang-ja').classList.toggle('active', lang==='ja');
            applyLang();
            renderHUD();
        }

        function t(key){
            return translations[currentLang]?.[key] ?? translations.en[key] ?? key;
        }

        function applyLang(){
            setText('start-subtitle', t('subtitle'));
            setText('start-run-btn', t('startBtn'));
            setText('ui-subtitle', t('subtitle'));
            setText('ui-title', translations.en.subtitle);
            // setText('ui-hint', t('hint')); // Removed
            setText('ui-goal-title', t('goalTitle'));
            setText('help-text', t('helpText'));
            setText('help-close', t('helpClose'));
        }

        // --- „Ç≤„Éº„É†ÂÆöÁæ© ---
        const COLOR_POOL = [
            { key: 'R', name:{en:'Crimson', ja:'Á¥Ö'}, hex:'#dc2626' }, // Rose-500 -> Red-600
            { key: 'B', name:{en:'Azure', ja:'Ëíº'}, hex:'#3b82f6' },
            { key: 'Y', name:{en:'Amber', ja:'Áê•ÁèÄ'}, hex:'#fbbf24' },
            { key: 'W', name:{en:'Ivory', ja:'Ë±°Áâô'}, hex:'#e2e8f0' },
            { key: 'K', name:{en:'Obsidian', ja:'Èªí'}, hex:'#0f172a' },
            { key: 'G', name:{en:'Emerald', ja:'Áø†'}, hex:'#22c55e' }, // Emerald-500 -> Green-500
            { key: 'P', name:{en:'Amethyst', ja:'Á¥´'}, hex:'#a855f7' }, 
            { key: 'O', name:{en:'Orange', ja:'Ê©ô'}, hex:'#f97316' }, 
            { key: 'T', name:{en:'Teal', ja:'ÈùíÁ∑ë'}, hex:'#06b6d4' }, // Teal-500 -> Cyan-500
            { key: 'M', name:{en:'Pink', ja:'Ê°É'}, hex:'#d946ef' }, // Pink-500 -> Fuchsia-500
        ];

        // --- Perks & Skills ---
        const PERKS = {
            catalyst: {
                id:'catalyst',
                name:{en:'Catalyst', ja:'Ëß¶Â™íÂèçÂøú'},
                rarity:'rare',
                desc:{en:'Once per floor: Completing a tube reduces Pressure by 5.', ja:'ÂêÑÈöéÂ±§1ÂõûÔºöËâ≤„ÇíÂÆåÊàê„Åï„Åõ„Çã„Å®ÂúßÂäõ„Åå5‰∏ã„Åå„Çã„ÄÇ'},
            },
            transmutation: {
                id:'transmutation',
                name:{en:'Transmutation', ja:'Áâ©Ë≥™Â§âÊèõ'},
                rarity:'rare',
                desc:{en:'Gain a random item at the start of each floor.', ja:'ÈöéÂ±§ÈñãÂßãÊôÇ„ÄÅ„É©„É≥„ÉÄ„É†„Å™„Ç¢„Ç§„ÉÜ„É†„Çí1„Å§Áç≤Âæó„Åô„Çã„ÄÇ'},
            },
            momentum: {
                id:'momentum',
                name:{en:'Momentum', ja:'ÊÖ£ÊÄßÂæã'},
                rarity:'common',
                desc:{en:'Pressure does not increase on the turn after completing a tube.', ja:'„ÉÅ„É•„Éº„Éñ„ÇíÂÆåÊàê„Åï„Åõ„ÅüÁõ¥Âæå„ÅÆ1„Çø„Éº„É≥„ÅØÂúßÂäõ„Åå‰∏äÊòá„Åó„Å™„ÅÑ„ÄÇ'},
            },
            reflux: {
                id:'reflux',
                name:{en:'Reflux', ja:'ÈÄÜÊµÅÂà∂Âæ°'},
                rarity:'common',
                desc:{en:'First undo each floor is free (Pressure +2).', ja:'ÂêÑÈöéÂ±§„ÄÅÊúÄÂàù„ÅÆUndo„ÅØ„Ç®„ÉÉ„Çª„É≥„ÇπÁÑ°ÊñôÔºàÂúßÂäõ+2„Åß‰ª£Áî®Ôºâ„ÄÇ'},
            },
            overflow: {
                id:'overflow',
                name:{en:'Overflow', ja:'„Ç™„Éº„Éê„Éº„Éï„É≠„Éº'},
                rarity:'common',
                desc:{en:'Pressure max +4.', ja:'ÂúßÂäõ„ÅÆÊúÄÂ§ßË®±ÂÆπÈáè„Åå+4„Åï„Çå„Çã„ÄÇ'},
            },
            purification: {
                id:'purification',
                name:{en:'Purification', ja:'ÊµÑÂåñ‰ΩúÁî®'},
                rarity:'epic',
                desc:{en:'Clearing Obsidian (Black) reduces Pressure by 3 and grants 2 Essence.', ja:'Èªí„Ç§„É≥„ÇØ„ÇíÊ∂àÊªÖ„Åï„Åõ„Çã„Å®„ÄÅÂúßÂäõ„Åå3‰∏ã„Åå„Çä„ÄÅ2„Ç®„ÉÉ„Çª„É≥„Çπ„ÇíÂæó„Çã„ÄÇ'},
            },
            scavenger: {
                id:'scavenger',
                name:{en:'Scavenger', ja:'„Çπ„Ç´„Éô„É≥„Ç∏„É£„Éº'},
                rarity:'rare',
                desc:{en:'15% chance to find a random item when descending.', ja:'ÈöéÂ±§ÁßªÂãïÊôÇ„ÄÅ15%„ÅÆÁ¢∫Áéá„Åß„É©„É≥„ÉÄ„É†„Å™„Ç¢„Ç§„ÉÜ„É†„ÇíÊãæ„ÅÜ„ÄÇ'},
            },
            bargain: {
                id:'bargain',
                name:{en:'Bargain', ja:'‰∫§Ê∏âË°ì'},
                rarity:'common',
                desc:{en:'Shop prices are reduced by 20%.', ja:'„Ç∑„Éß„ÉÉ„Éó„ÅÆ‰æ°Ê†º„Åå20%OFF„Å´„Å™„Çã„ÄÇ'},
            },
            heavy_mastery: {
                id:'heavy_mastery',
                name:{en:'Heavy Mastery', ja:'Â§ßÂÆπÈáè„Éú„Éº„Éä„Çπ'},
                rarity:'rare',
                desc:{en:'Clearing a tube with capacity 5+ reduces Pressure by 3.', ja:'ÂÆπÈáè5‰ª•‰∏ä„ÅÆ„ÉÅ„É•„Éº„Éñ„ÇíÂÆåÊàê„Åï„Åõ„Çã„Å®ÂúßÂäõ„Åå3‰∏ã„Åå„Çã„ÄÇ'},
            },
            deep_adapt: {
                id:'deep_adapt',
                name:{en:'Deep Adapt', ja:'Ê∑±Â±§ÈÅ©Âøú'},
                rarity:'epic',
                desc:{en:'Gain Max HP based on current tube capacity at start of floor.', ja:'ÈöéÂ±§ÈñãÂßãÊôÇ„ÄÅÁèæÂú®„ÅÆ„ÉÅ„É•„Éº„ÉñÂÆπÈáè„Å´Âøú„Åò„Å¶ÊúÄÂ§ßHP„ÅåÂ¢óÂä†„Åô„Çã„ÄÇ'},
            }
        };

        const ITEMS = {
            pipette: {
                id: 'pipette',
                type: 'tool', 
                name: {en:'Pipette', ja:'Á≤æÂØÜ„Éî„Éö„ÉÉ„Éà'},
                desc: {en:'Toggle: Pour only 1 segment.', ja:'ÂàáÊõøÔºö1ÁõÆÁõõ„Çä„Å†„ÅëÊ≥®„Åê„É¢„Éº„Éâ'},
                icon: '‚öóÔ∏è',
                cost: 10
            },
            inverter: {
                id: 'inverter',
                type: 'consumable',
                name: {en:'Gravity Coil', ja:'ÈáçÂäõÂèçËª¢Ê©ü'},
                desc: {en:'„ÄêUse„ÄëInvert contents.', ja:'„Äê‰ΩøÁî®„Äë‰∏≠Ë∫´„Çí‰∏ä‰∏ãÂèçËª¢'},
                icon: 'üîÑ',
                cost: 6
            },
            void_salt: {
                id: 'void_salt',
                type: 'consumable',
                name: {en:'Void Salt', ja:'ËôöÁÑ°„ÅÆÂ°©'},
                desc: {en:'„ÄêUse„ÄëRemove top Black.', ja:'„Äê‰ΩøÁî®„Äë‰∏ÄÁï™‰∏ä„ÅÆ„ÄêÈªí„Äë„ÇíÈô§Âéª'},
                icon: 'üßÇ',
                cost: 8
            },
            separator: {
                id: 'separator',
                type: 'consumable',
                name: {en:'Separator', ja:'ÈÅ†ÂøÉÂàÜÈõ¢Ê©ü'},
                desc: {en:'„ÄêUse„ÄëSort tube contents.', ja:'„Äê‰ΩøÁî®„Äë‰∏≠Ë∫´„ÇíÊï¥ÁêÜ„Åô„Çã'},
                icon: 'üå™Ô∏è',
                cost: 12
            },
            summon_vial: {
                id: 'summon_vial',
                type: 'consumable',
                name: {en:'Extra Vial', ja:'‰∫àÂÇô„Éï„É©„Çπ„Ç≥'},
                desc: {en:'„ÄêUse„ÄëAdd an empty tube.', ja:'„Äê‰ΩøÁî®„ÄëÁ©∫„ÅçÁì∂„Çí1„Å§ËøΩÂä†'},
                icon: 'üß™',
                cost: 15
            },
            cycle_siphon: {
                id: 'cycle_siphon',
                type: 'consumable',
                name: {en:'Cycle Siphon', ja:'Âæ™Áí∞„Çµ„Ç§„Éï„Ç©„É≥'},
                desc: {en:'„ÄêUse„ÄëMove bottom to top.', ja:'„Äê‰ΩøÁî®„Äë‰∏ÄÁï™‰∏ã„Çí‰∏ÄÁï™‰∏ä„Å∏'},
                icon: '‚è´',
                cost: 9
            }
        };

        const SHOP_ITEMS = [
            { id:'heal', type:'stat', name:{en:'Stabilizer', ja:'ÂÆâÂÆöÂâ§'}, cost:8, desc:{en:'Heal +1 HP', ja:'HP+1'}, apply(gs){ gs.hp += 1; showToast('HP Recovered!', 'rose'); } },
            { id:'relief', type:'stat', name:{en:'Vent Valve', ja:'ÂúßÂäõÂºÅ'}, cost:5, desc:{en:'Pressure -5', ja:'ÂúßÂäõ-5'}, apply(gs){ gs.pressure = Math.max(0, gs.pressure-5); showToast('Pressure Released!', 'sky'); } },
            { id:'buy_pipette', type:'item', ref: ITEMS.pipette },
            { id:'buy_inverter', type:'item', ref: ITEMS.inverter },
            { id:'buy_separator', type:'item', ref: ITEMS.separator },
            { id:'buy_siphon', type:'item', ref: ITEMS.cycle_siphon },
            { id:'buy_void', type:'item', ref: ITEMS.void_salt },
            { id:'buy_summon', type:'item', ref: ITEMS.summon_vial },
        ];

        // --- „Ç≤„Éº„É†Áä∂ÊÖã ---
        const gameState = {
            floor: 1,
            essence: 0,
            hp: 3,
            maxHp: 3,
            turnCount: 0, 
            capacity: 4,
            tubeCount: 0,
            selectedIdx: null,
            tubes: [],
            busy: false,
            perks: new Set(),
            inventory: {}, 
            pressure: 0,
            pressureMax: 14,
            catalystAvailable: true,
            refluxArmed: false,
            momentumActive: false, // New State
            history: [],
            primaryGoal: null,
            secondaryGoal: null,
            secondaryProgress: 0,
            focusIdx: null, 
            currentPerkChoices: null,
            pipetteMode: false,
            targetMode: null, 
        };

        // --- DOM ---
        const tubesContainer = ui('tubes-container');
        const boardArea = ui('board-area'); // „Çπ„Ç±„Éº„É™„É≥„Ç∞Ë®àÁÆóÁî®
        const skillsContainer = ui('skills-container');
        const startScreen = ui('start-screen');
        const perkScreen = ui('perk-screen');
        const perkCards = ui('perk-cards');
        const shopCards = ui('shop-cards');
        const continueBtn = ui('continue-btn');
        const rerollBtn = ui('reroll-btn');
        const helpScreen = ui('help-screen');
        const settingsScreen = ui('settings-screen');
        const eventScreen = ui('event-screen');
        const eventChoices = ui('event-choices');
        const devTests = ui('dev-tests');
        const alertBanner = ui('alert-banner');
        const undoBtn = ui('btn-undo');

        // --- Game Logic ---

        function tubeTop(t){ return t.length ? t[t.length-1] : null; }
        function tubeFree(t){ return gameState.capacity - t.length; }
        function isCompleteTube(t){
            if (t.length !== gameState.capacity) return false;
            return t.every(c => c === t[0]);
        }
        function colorMeta(key){ return COLOR_POOL.find(c => c.key===key); }
        function colorName(key){ const m=colorMeta(key); return currentLang==='ja' ? m.name.ja : m.name.en; }

        function generateGoals(){
            const flat = gameState.tubes.flat();
            const presentColors = new Set(flat);
            presentColors.delete('K'); 
            const colors = [...presentColors];

            if (colors.length === 0) {
                gameState.primaryGoal = { type:'survive', text: currentLang==='ja'?'Áîü„ÅçÂª∂„Å≥„Çç':'Survive' };
                return;
            }

            const roll = Math.random();
            if (roll < 0.50){
                const maxN = colors.length;
                const n = clamp(Math.floor(maxN / 1.5), 1, maxN);
                gameState.primaryGoal = {
                    type:'completeN', n:n,
                    text: currentLang==='ja' ? `„ÅÑ„Åö„Çå„Åã${n}Ëâ≤„ÇíÂÆåÊàê` : `Complete any ${n} colors`
                };
            } else {
                const c = pick(colors);
                gameState.primaryGoal = {
                    type:'completeColor', color:c,
                    text: currentLang==='ja' ? `${colorName(c)}„ÇíÂÆåÊàê` : `Complete ${colorName(c)}`
                };
            }
            
            const sroll = Math.random();
            const par = 14 + Math.floor(gameState.floor / 2) + 5; 
            if (sroll < 0.5){
                gameState.secondaryGoal = {
                    type:'speed', limit: par,
                    text: currentLang==='ja' ? `${par}„Çø„Éº„É≥‰ª•ÂÜÖ„Å´1Êú¨ÂÆåÊàê` : `Complete 1 within ${par} turns`
                };
            } else {
                gameState.secondaryGoal = {
                    type:'combo', need:2,
                    text: currentLang==='ja' ? 'ÈÄ£Á∂öÂÆåÊàêÔºà„Ç≥„É≥„ÉúÔºâ' : 'Combo: 2 in a row'
                };
            }
            gameState.secondaryProgress = 0;
            renderHUD();
        }

        function checkPrimaryGoal(){
            if (gameState.primaryGoal.type === 'completeN') {
                return countCompletedTubes() >= gameState.primaryGoal.n;
            }
            if (gameState.primaryGoal.type === 'completeColor'){
                return gameState.tubes.some(t => isCompleteTube(t) && t[0] === gameState.primaryGoal.color);
            }
            if (gameState.primaryGoal.type === 'survive') return false; 
            return false;
        }
        
        function checkLevelClear(){
            if (checkPrimaryGoal()) return true;
            const allClean = gameState.tubes.every(t => t.length === 0 || (isCompleteTube(t) && t[0] !== 'K'));
            if (allClean) return true;
            return false;
        }

        function checkSecondaryGoalOnComplete(){
            if (!gameState.secondaryGoal) return;
            if (gameState.secondaryGoal.type === 'speed'){
                if (gameState.turnCount <= gameState.secondaryGoal.limit){
                    gameState.secondaryProgress = 1; 
                }
            } else if (gameState.secondaryGoal.type === 'combo'){
                gameState.secondaryProgress += 1;
            }
        }

        function secondarySucceeded(){
            if (!gameState.secondaryGoal) return false;
            if (gameState.secondaryGoal.type === 'speed') return gameState.secondaryProgress >= 1;
            if (gameState.secondaryGoal.type === 'combo') return gameState.secondaryProgress >= gameState.secondaryGoal.need;
            return false;
        }
        
        function isDeadlocked(){
            for(let i=0; i<gameState.tubes.length; i++){
                if(gameState.tubes[i].length === 0) continue; 
                for(let j=0; j<gameState.tubes.length; j++){
                    if(i===j) continue;
                    const check = canPour(i, j);
                    if(check.ok) return false; 
                }
            }
            return true; 
        }

        function generateBoard(){
            const floor = gameState.floor;
            gameState.tubeCount = Math.min(10, 6 + Math.floor((floor-1)/2));
            const numColors = gameState.tubeCount - 2;

            const safeNumColors = Math.min(numColors, COLOR_POOL.length);
            
            const pool = COLOR_POOL.slice(0, Math.min(COLOR_POOL.length, safeNumColors + (floor > 5 ? 1 : 0))).map(c=>c.key);
            const colors = [];
            
            let failsafe = 0;
            while(colors.length < safeNumColors){
                const c = pick(pool);
                if(!colors.includes(c)) colors.push(c);
                
                failsafe++;
                if(failsafe > 100) break; 
            }

            const bag = [];
            for (const c of colors) for (let i=0;i<gameState.capacity;i++) bag.push(c);

            for (let i=bag.length-1;i>0;i--){
                const j = randInt(i+1);
                [bag[i], bag[j]] = [bag[j], bag[i]];
            }

            const tubes = Array.from({length: gameState.tubeCount}, () => []);
            let k=0;
            for (let t=0;t<safeNumColors;t++){
                for (let s=0;s<gameState.capacity;s++) {
                    if(k < bag.length) tubes[t].push(bag[k++]);
                }
            }

            for (let i=0;i<20;i++){
                const t1 = randInt(safeNumColors);
                const t2 = randInt(safeNumColors);
                if (t1===t2) continue;
                const s1 = randInt(gameState.capacity);
                const s2 = randInt(gameState.capacity);
                if(tubes[t1][s1] && tubes[t2][s2]) {
                    [tubes[t1][s1], tubes[t2][s2]] = [tubes[t2][s2], tubes[t1][s1]];
                }
            }

            gameState.tubes = tubes;
            updateTubeLayout();
        }
        
        function updateTubeLayout(){
            const cap = gameState.capacity;
            let segHeight = 40;
            if(cap >= 6) segHeight = 32;
            else if(cap >= 5) segHeight = 36;
            
            // „ÉÅ„É•„Éº„Éñ„ÅÆÈ´ò„Åï„ÇíÂÆπÈáè„Å´Âêà„Çè„Åõ„Å¶Ë®àÁÆó (segHeight * cap + top/bottom padding approx 20-30px)
            // Â∞ë„Åó‰ΩôË£ï„ÇíÊåÅ„Åü„Åõ„Çã (‰æã: +40px)
            const tubeHeight = (segHeight * cap) + 40;

            document.documentElement.style.setProperty('--segment-height', `${segHeight}px`);
            document.documentElement.style.setProperty('--tube-height', `${tubeHeight}px`);
        }

        // --- Render ---
        function renderBoard(){
            tubesContainer.innerHTML = '';
            
            const deadlocked = isDeadlocked();
            if (alertBanner) alertBanner.style.opacity = deadlocked ? '1' : '0';

            gameState.tubes.forEach((segments, i) => {
                const tube = document.createElement('div');
                tube.className = 'tube';
                tube.dataset.idx = String(i);

                if (i === gameState.selectedIdx) tube.classList.add('selected');
                
                if (gameState.focusIdx !== null && i === gameState.focusIdx) {
                    tube.classList.add('tube-focused');
                }
                
                if (deadlocked) tube.classList.add('deadlock-glow');
                
                if (gameState.targetMode) {
                    tube.classList.add('target-mode');
                    tube.style.cursor = 'crosshair';
                }

                if (isCompleteTube(segments)) {
                    if (segments[0] !== 'K') {
                        tube.style.boxShadow = `0 0 15px ${colorMeta(segments[0]).hex}`;
                        tube.style.borderColor = `rgba(255,255,255,0.5)`;
                    }
                }

                const water = document.createElement('div');
                water.className = 'water-container';

                segments.forEach(key => {
                    const c = colorMeta(key)?.hex || '#64748b';
                    const seg = document.createElement('div');
                    seg.className = 'water-segment';
                    seg.style.backgroundColor = c;
                    water.appendChild(seg);
                });

                tube.appendChild(water);
                tube.addEventListener('click', () => handleTubeClick(i));
                tubesContainer.appendChild(tube);
            });
            
            renderSkills();
            
            // „É¨„É≥„ÉÄ„É™„É≥„Ç∞Âæå„Å´„Çµ„Ç§„Ç∫Ë™øÊï¥„ÇíÂÆüË°å
            // DOMÊõ¥Êñ∞ÂÆå‰∫Ü„ÇíÂæÖ„Å§„Åü„ÇÅ„Å´requestAnimationFrame„Çí‰ΩøÁî®
            requestAnimationFrame(adjustBoardScale);
        }
        
        // --- Ëá™Âãï„Çπ„Ç±„Éº„É™„É≥„Ç∞Âá¶ÁêÜ ---
        function adjustBoardScale() {
            if (!boardArea || !tubesContainer) return;
            
            // ‰∏ÄÊó¶„É™„Çª„ÉÉ„Éà„Åó„Å¶Êú¨Êù•„ÅÆ„Çµ„Ç§„Ç∫„ÇíË®àÊ∏¨
            tubesContainer.style.transform = 'none';
            
            const availableW = boardArea.clientWidth;
            const availableH = boardArea.clientHeight;
            
            const contentW = tubesContainer.scrollWidth;
            const contentH = tubesContainer.scrollHeight;
            
            // „Éû„Éº„Ç∏„É≥ÂàÜ„ÇíËÄÉÊÖÆ„Åó„Å¶Â∞ë„ÅóÂ∞è„Åï„ÇÅ„Å´
            const safeW = availableW * 0.95;
            const safeH = availableH * 0.95;
            
            let scale = 1;
            
            if (contentW > safeW || contentH > safeH) {
                scale = Math.min(safeW / contentW, safeH / contentH);
            }
            
            // Ê•µÁ´Ø„Å´Â∞è„Åï„Åè„Å™„Çä„Åô„Åé„Å™„ÅÑ„Çà„ÅÜ„Å´Âà∂Èôê (‰æã: 0.4ÂÄç„Åæ„Åß)
            scale = Math.max(scale, 0.4);
            
            if (scale < 1) {
                tubesContainer.style.transform = `scale(${scale})`;
            }
        }
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫Â§âÊõ¥ÊôÇ„ÇÇÂÆüË°å
        window.addEventListener('resize', () => {
            requestAnimationFrame(adjustBoardScale);
        });
        
        function renderSkills(){
            skillsContainer.innerHTML = '';
            // Inventory check
            Object.keys(gameState.inventory).forEach(key => {
                const count = gameState.inventory[key];
                if(count > 0 || ITEMS[key].type === 'tool'){
                    const def = ITEMS[key];
                    const btn = document.createElement('button');
                    btn.className = 'skill-btn w-12 h-12 glass-panel flex items-center justify-center text-xl rounded-full border border-white/10 shrink-0';
                    
                    // Name and Desc
                    const name = currentLang==='ja' ? def.name.ja : def.name.en;
                    const desc = currentLang==='ja' ? def.desc.ja : def.desc.en;

                    // Badge and Tooltip HTML
                    let badgeHtml = '';
                    if(def.type === 'consumable'){
                        badgeHtml = `<span class="absolute -top-1 -right-1 bg-sky-500 text-[10px] font-bold px-1.5 rounded-full text-white pointer-events-none">${count}</span>`;
                    }

                    btn.innerHTML = `
                        ${def.icon}
                        ${badgeHtml}
                        <div class="skill-tooltip">
                            <div class="font-bold text-sky-300 text-xs mb-1">${name}</div>
                            <div class="text-slate-300 text-[10px] leading-tight whitespace-pre-wrap">${desc}</div>
                        </div>
                    `;
                    
                    // Active state
                    if(key === 'pipette' && gameState.pipetteMode) btn.classList.add('active');
                    if(gameState.targetMode === key) btn.classList.add('active-mode');

                    btn.onclick = () => activateSkill(key);
                    skillsContainer.appendChild(btn);
                }
            });
        }

        function activateSkill(key){
            if(gameState.busy) return;
            const def = ITEMS[key];
            
            if(def.id === 'summon_vial'){
                 if(gameState.inventory[key] > 0){
                     gameState.inventory[key]--;
                     gameState.tubeCount++;
                     gameState.tubes.push([]); // Á©∫„ÅÆ„ÉÅ„É•„Éº„ÉñËøΩÂä†
                     // Fix: Render board first, then show float text on the new tube
                     renderBoard();
                     showFloatText(gameState.tubes.length-1, "Summoned!", "#a855f7");
                     showToast(currentLang==='ja'?'Á©∫„ÅçÁì∂„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ':'Extra Tube Added!', 'purple');
                 }
                 return;
            }
            
            if(def.type === 'tool' && key === 'pipette'){
                // Toggle
                gameState.pipetteMode = !gameState.pipetteMode;
                gameState.targetMode = null; 
                gameState.selectedIdx = null; 
            } else if (def.type === 'consumable'){
                // Toggle Target Mode
                if(gameState.targetMode === key){
                    gameState.targetMode = null; 
                } else {
                    gameState.targetMode = key;
                    gameState.selectedIdx = null; 
                    gameState.pipetteMode = false; 
                    
                    // Hint text logic removed; replaced with toast for feedback
                    showToast(currentLang==='ja' ? "ÂØæË±°„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" : "Select a target tube", 'sky');
                }
            }
            renderBoard();
        }

        async function handleTubeClick(idx) {
            if (gameState.busy) return;
            
            // --- Skill Target Logic ---
            if (gameState.targetMode) {
                await applySkillEffect(idx);
                return;
            }

            const content = gameState.tubes[idx];

            // ÈÅ∏ÊäûËß£Èô§
            if (gameState.selectedIdx === idx) {
                gameState.selectedIdx = null;
                renderBoard();
                return;
            }

            // Êñ∞Ë¶èÈÅ∏Êäû
            if (gameState.selectedIdx === null) {
                if (content.length === 0) return;
                
                // ÂÆåÊàê„Åó„Åü„ÉÅ„É•„Éº„Éñ„ÅØÈÅ∏Êäû‰∏çÂèØÔºàÈªí„Ç§„É≥„ÇØÂê´„ÇÄÔºâ
                // ÂÖÉ: && !gameState.unsealActive „Åå„ÅÇ„Å£„Åü„ÅåÂâäÈô§
                if (isCompleteTube(content)) return; 

                gameState.selectedIdx = idx;
                renderBoard();
            } else {
                // ÁßªÂãïË©¶Ë°å
                await tryPour(gameState.selectedIdx, idx);
            }
        }
        
        async function applySkillEffect(idx){
            const skillKey = gameState.targetMode;
            const tube = gameState.tubes[idx];
            
            if(!skillKey || !gameState.inventory[skillKey] || gameState.inventory[skillKey] <= 0) return;
            
            let success = false;
            
            try {
                gameState.busy = true;

                if(skillKey === 'inverter'){
                    if(tube.length < 2) {
                        showFloatText(idx, "Too Empty!", "#ef4444");
                    } else {
                        pushHistory();
                        gameState.inventory[skillKey]--;
                        tube.reverse(); 
                        showFloatText(idx, "Inverted!", "#a855f7");
                        success = true;
                    }
                } else if (skillKey === 'void_salt'){
                    if(tube.length === 0){
                        showFloatText(idx, "Empty!", "#ef4444");
                    } else {
                        const topColor = tube[tube.length-1];
                        if(topColor !== 'K'){
                            showFloatText(idx, "Pure Element!", "#ef4444");
                        } else {
                            pushHistory();
                            gameState.inventory[skillKey]--;
                            tube.pop();
                            showFloatText(idx, "Voided!", "#a855f7");
                            success = true;
                        }
                    }
                } else if (skillKey === 'separator'){
                    if(tube.length < 2) {
                        showFloatText(idx, "No need!", "#ef4444");
                    } else {
                        pushHistory();
                        gameState.inventory[skillKey]--;
                        const counts = {};
                        const order = [];
                        for(const c of tube){
                            if(!counts[c]) { counts[c]=0; order.push(c); }
                            counts[c]++;
                        }
                        const newTube = [];
                        for(const c of order){
                            for(let i=0; i<counts[c]; i++) newTube.push(c);
                        }
                        gameState.tubes[idx] = newTube;
                        
                        showFloatText(idx, "Separated!", "#a855f7");
                        success = true;
                    }
                } else if (skillKey === 'cycle_siphon'){
                     if(tube.length === 0) {
                        showFloatText(idx, "Empty!", "#ef4444");
                     } else {
                        pushHistory();
                        gameState.inventory[skillKey]--;
                        const bottom = tube.shift(); // Remove bottom
                        tube.push(bottom); // Add to top
                        showFloatText(idx, "Cycled!", "#a855f7");
                        success = true;
                     }
                }
            } finally {
                gameState.busy = false;
            }
            
            if(success){
                gameState.targetMode = null;
                renderHUD();
                renderBoard();
                
                // Check if skill caused completion
                if(isCompleteTube(gameState.tubes[idx])){
                    await handleCompletion(idx, gameState.tubes[idx][0]);
                }
            }
        }

        function canPour(fromIdx, toIdx){
            if (fromIdx === toIdx) return {ok:false, reason:'same'};
            const from = gameState.tubes[fromIdx];
            const to = gameState.tubes[toIdx];
            if (!from.length) return {ok:false, reason:'empty'};
            if (tubeFree(to) <= 0) return {ok:false, reason:'full'};

            const top = tubeTop(from);
            const toTop = tubeTop(to);

            if (toTop && toTop !== top) return {ok:false, reason:'mismatch'};

            // ÁßªÂãïÈáèË®àÁÆó
            let count = 1;
            // Pipette Mode: Force 1
            if(gameState.pipetteMode){
                count = 1;
            } else {
                for (let i=from.length-2;i>=0;i--){
                    if (from[i] === top) count++;
                    else break;
                }
            }
            
            const moveCount = Math.min(count, tubeFree(to));
            return {ok:true, color: top, moveCount};
        }

        function pushHistory(){
            gameState.history.push({
                tubes: deepCopy(gameState.tubes),
                turnCount: gameState.turnCount,
                pressure: gameState.pressure,
                hp: gameState.hp,
                secondaryProgress: gameState.secondaryProgress,
                catalystAvailable: gameState.catalystAvailable,
                essence: gameState.essence,
                inventory: {...gameState.inventory},
                tubeCount: gameState.tubeCount,
                momentumActive: gameState.momentumActive 
            });
            if (gameState.history.length > 50) gameState.history.shift();
        }

        async function tryPour(fromIdx, toIdx){
            const check = canPour(fromIdx, toIdx);
            if (!check.ok){
                const content = gameState.tubes[toIdx];
                // Unseal Removed: ÂÆå‰∫Ü„Åó„Åü„ÉÅ„É•„Éº„Éñ„ÅØÈÅ∏Êäû‰∏çÂèØ
                if (content.length > 0 && !isCompleteTube(content)) {
                    gameState.selectedIdx = toIdx;
                } else {
                    gameState.selectedIdx = null;
                }
                renderBoard();
                return;
            }

            try {
                pushHistory();
                gameState.busy = true;
                
                // --- Momentum Check ---
                if(gameState.momentumActive){
                    // ÂúßÂäõ‰∏äÊòá„Å™„Åó
                    gameState.momentumActive = false; // Ê∂àË≤ª
                    showFloatText(toIdx, "Momentum!", "#a855f7");
                } else {
                    gameState.pressure += 1;
                }
                
                gameState.turnCount += 1;

                // Visual stream: Êï∞Èáè„ÇÇÊ∏°„Åó„Å¶„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂà∂Âæ°
                await animatePour(fromIdx, toIdx, check.color, check.moveCount);

                const from = gameState.tubes[fromIdx];
                const to = gameState.tubes[toIdx];
                const moveCount = check.moveCount;

                for (let i=0;i<moveCount;i++){
                    to.push(from.pop());
                }

                // Check completion for the destination tube
                if(isCompleteTube(to)){
                    await handleCompletion(toIdx, to[0]);
                } else {
                    if (gameState.secondaryGoal?.type === 'combo') gameState.secondaryProgress = 0;
                }

                if (gameState.pressure >= gameState.pressureMax){
                    gameState.pressure = 0;
                    gameState.hp -= 1;
                    ui('game-container').classList.add('animate-shake');
                    setTimeout(()=>ui('game-container').classList.remove('animate-shake'), 500);
                    corruptRandomSegment();
                }
            } catch (e) {
                console.error("Game Logic Error:", e);
            } finally {
                gameState.selectedIdx = null;
                gameState.busy = false;
            }

            // Ê≠ª‰∫°Âà§ÂÆö„ÇíHP„ÅÆ„Åø„Å´Â§âÊõ¥
            if (gameState.hp <= 0){
                openPerkScreen(true);
                return;
            }

            // All ClearÂà§ÂÆö„Çí‰ΩøÁî®
            if (checkLevelClear()){
                gameState.essence += 6 + (secondarySucceeded() ? 4 : 0);
                setTimeout(() => openPerkScreen(false), 500);
                return;
            }

            renderHUD();
            renderBoard();
        }

        async function handleCompletion(tubeIdx, colorKey){
            const tubeEl = tubeCenterEl(tubeIdx);
            
            // Èªí„Ç§„É≥„ÇØ„ÅÆÂ†¥ÂêàÔºöÊ∂àÊªÖÂá¶ÁêÜ
            if (colorKey === 'K') {
                showFloatText(tubeIdx, "Purged!", "#94a3b8");
                
                // Perk: Purification check
                if(gameState.perks.has('purification')){
                    gameState.pressure = Math.max(0, gameState.pressure - 3);
                    gameState.essence += 2;
                    showFloatText(tubeIdx, "Purified! (-3 Pressure)", "#38bdf8");
                }
                
                // „Ç®„Éï„Çß„ÇØ„ÉàÂæÖÊ©ü
                tubeEl.classList.add('evaporating');
                await new Promise(r => setTimeout(r, 600));
                
                gameState.tubes[tubeIdx] = []; // Empty the tube
                tubeEl.classList.remove('evaporating');
                
                // ÈªíÊ∂àÊªÖÂæå„ÄÅÁõ§Èù¢„ÅÆÂÜçÊèèÁîª„Å®„ÇØ„É™„Ç¢Âà§ÂÆö„ÇíË°å„ÅÜ
                renderBoard();
                
                if (checkLevelClear()){
                    gameState.essence += 6 + (secondarySucceeded() ? 4 : 0);
                    setTimeout(() => openPerkScreen(false), 500);
                }
                
                return; // „Ç§„Éô„É≥„Éà„ÅØÁô∫Áîü„Åó„Å™„ÅÑ
            }

            // ÈÄöÂ∏∏Ëâ≤„ÅÆÂ†¥Âêà
            if (gameState.perks.has('catalyst') && gameState.catalystAvailable){
                gameState.pressure = Math.max(0, gameState.pressure - 5);
                gameState.catalystAvailable = false;
                showFloatText(tubeIdx, "Catalyst! (-5 Pressure)");
            }
            
            // Perk: Heavy Mastery
            if(gameState.perks.has('heavy_mastery') && gameState.capacity >= 5){
                 gameState.pressure = Math.max(0, gameState.pressure - 3);
                 showFloatText(tubeIdx, "Heavy Bonus! (-3 Pressure)", "#a855f7");
            }
            
            // Perk: Momentum Activate
            if(gameState.perks.has('momentum')){
                gameState.momentumActive = true;
                // Float text will be shown on next move
            }
            
            checkSecondaryGoalOnComplete();
            await showCompletionEvent(colorKey);
        }

        function countCompletedTubes(){
            // Èªí„Ç§„É≥„ÇØÂÆå‰∫Ü„ÅØ‰∏ÄÁû¨„ÅßÊ∂à„Åà„Çã„ÅÆ„Åß„ÄÅ„Åì„ÅÆÂà§ÂÆö„Å´ÊÆã„Çã„Åì„Å®„ÅØ„Åª„Åº„Å™„ÅÑ„Åå„ÄÅ
            // ÂÆå‰∫ÜÁä∂ÊÖã = ÂÆπÈáèMax„Åã„Å§ÂêåËâ≤
            return gameState.tubes.filter(t => isCompleteTube(t) && t[0] !== 'K').length;
        }

        function corruptRandomSegment(){
            const candidates = [];
            for (let i=0;i<gameState.tubes.length;i++){
                const t = gameState.tubes[i];
                // Â§âÊõ¥ÁÇπ: „Éà„ÉÉ„Éó„ÅåÈªí('K')„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÂÄôË£ú„Å´„Åô„Çã
                if (t.length < gameState.capacity && (t.length === 0 || t[t.length-1] !== 'K')) {
                    candidates.push(i);
                }
            }
            if (!candidates.length) return;

            const idx = pick(candidates);
            gameState.tubes[idx].push('K');
            showFloatText(idx, "CORRUPTED!", "#ef4444");
        }

        function showFloatText(tubeIdx, text, color="#38bdf8"){
            const el = ui('tubes-container').children[tubeIdx];
            if(!el) return;
            const rect = el.getBoundingClientRect();
            const float = document.createElement('div');
            float.textContent = text;
            float.style.position = 'fixed';
            float.style.left = rect.left + 'px';
            float.style.top = rect.top + 'px';
            float.style.color = color;
            float.style.fontWeight = 'bold';
            float.style.fontSize = '14px';
            float.style.pointerEvents = 'none';
            float.style.zIndex = 100;
            float.style.textShadow = '0 2px 4px rgba(0,0,0,0.8)';
            float.animate([
                { transform: 'translateY(0)', opacity: 1 },
                { transform: 'translateY(-30px)', opacity: 0 }
            ], { duration: 1000, easing: 'ease-out' });
            document.body.appendChild(float);
            setTimeout(()=>float.remove(), 1000);
        }

        function tubeCenterEl(idx){
            return ui('tubes-container').querySelector(`[data-idx="${idx}"]`);
        }

        function animatePour(fromIdx, toIdx, colorKey, count){
            return new Promise((resolve) => {
                const fromEl = tubeCenterEl(fromIdx);
                const toEl = tubeCenterEl(toIdx);
                if (!fromEl || !toEl){ resolve(); return; }
                
                const fromWater = fromEl.querySelector('.water-container');
                const toWater = toEl.querySelector('.water-container');
                
                // Ê≥®„ÅêÂÅ¥: DOM„ÅÆÊú´Â∞æ„Åã„ÇâcountÂÄã„ÇíÂèñÂæó (column-reverse„Å™„ÅÆ„ÅßÊú´Â∞æ„Åå‰∏ÄÁï™‰∏ä)
                const shrinkSegments = [];
                for(let i=0; i<count; i++){
                    if(fromWater.children.length > i){
                        shrinkSegments.push(fromWater.children[fromWater.children.length - 1 - i]);
                    }
                }
                
                // Ê≥®„Åå„Çå„ÇãÂÅ¥: Ëâ≤ÊÉÖÂ†±
                const colorHex = colorMeta(colorKey)?.hex || '#64748b';

                // ÂõûËª¢ÊñπÂêë
                const fr = fromEl.getBoundingClientRect();
                const tr = toEl.getBoundingClientRect();
                const isRight = tr.left > fr.left;
                
                // 1. ÂõûËª¢ÈñãÂßã
                fromEl.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                fromEl.style.transform = `translateY(-10px) rotate(${isRight ? 45 : -45}deg)`;
                fromEl.style.zIndex = 50; 
                
                // 2. Â∞ë„ÅóÈÅÖ„Çå„Å¶Ê∂≤Èù¢Â§âÂãïÈñãÂßã
                setTimeout(() => {
                    // Ê∏õ„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                    shrinkSegments.forEach(seg => {
                        if(seg) {
                            seg.style.height = '0px';
                            seg.style.opacity = '0';
                            seg.style.borderTop = 'none'; 
                        }
                    });
                    
                    // Â¢ó„Åà„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                    for(let i=0; i<count; i++){
                        const newSeg = document.createElement('div');
                        newSeg.className = 'water-segment';
                        newSeg.style.backgroundColor = colorHex;
                        newSeg.style.height = '0px';
                        newSeg.style.opacity = '0.5';
                        toWater.appendChild(newSeg);
                        
                        // Reflow
                        void newSeg.offsetWidth;
                        
                        newSeg.style.height = 'var(--segment-height)';
                        newSeg.style.opacity = '1';
                    }
                }, 50);

                // 3. ÂÆå‰∫ÜÂá¶ÁêÜ
                setTimeout(() => {
                    fromEl.style.transform = '';
                    fromEl.style.zIndex = '';
                    resolve();
                }, 400); 
            });
        }

        // --- Event / Screens ---
        function showCompletionEvent(colorKey){
            return new Promise((resolve) => {
                const name = colorName(colorKey);
                const title = currentLang==='ja' ? `${name}„ÅÆÂÆâÂÆöÂåñ` : `${name} Stabilized`;
                const desc = currentLang==='ja'
                    ? `${name}„ÇíÂÆåÊàê„Åï„Åõ„Åü„ÄÇ\nÊ∑±Ê∑µ„ÅåÂèçÂøú„Åó„Å¶„ÅÑ„Çã„ÄÇ`
                    : `You completed ${name}.\nThe abyss reacts to your achievement.`;

                const choices = buildEventChoices(colorKey);
                
                ui('event-kicker').textContent = t('eventKicker');
                ui('event-title').textContent = title;
                ui('event-desc').textContent = desc;
                eventChoices.innerHTML = '';

                choices.forEach(ch => {
                    const card = document.createElement('div');
                    card.className = 'glass-panel perk-card p-4 cursor-pointer hover:bg-white/5 border-l-4 border-l-sky-500';
                    card.innerHTML = `
                        <div class="text-[10px] text-sky-300 uppercase tracking-[0.35em] mb-1">${ch.kicker}</div>
                        <div class="text-xl font-black text-white">${ch.title}</div>
                        <div class="text-slate-400 text-xs mt-2 leading-relaxed">${ch.desc}</div>
                    `;
                    card.onclick = () => {
                        ch.apply();
                        eventScreen.classList.add('hidden');
                        eventScreen.classList.remove('flex');
                        renderHUD();
                        renderBoard();
                        resolve();
                    };
                    eventChoices.appendChild(card);
                });

                eventScreen.classList.remove('hidden');
                eventScreen.classList.add('flex');
            });
        }

        function buildEventChoices(colorKey){
            if (colorKey === 'B'){ 
                return [
                    {
                        kicker: currentLang==='ja' ? 'ÊéíÂá∫' : 'Vent',
                        title: currentLang==='ja' ? 'ÂúßÂäõ -4' : 'Pressure -4',
                        desc: currentLang==='ja' ? 'ÂÆâÂÖ®„ÇíÁ¢∫‰øù„Åô„Çã' : 'Release built-up pressure.',
                        apply(){ gameState.pressure = Math.max(0, gameState.pressure-4); }
                    },
                    {
                        kicker: currentLang==='ja' ? 'Áü•Ë≠ò' : 'Insight',
                        title: currentLang==='ja' ? '„Ç®„ÉÉ„Çª„É≥„Çπ +4' : 'Essence +4',
                        desc: currentLang==='ja' ? '„É™„Çπ„ÇØ„ÇíÂèñ„Å£„Å¶ÂØå„ÇíÂæó„Çã' : 'Gain currency for the shop.',
                        apply(){ gameState.essence += 4; }
                    }
                ];
            }
            if (colorKey === 'R'){
                return [
                    {
                        kicker: currentLang==='ja' ? 'Ê¥ªÂäõ' : 'Vitality',
                        title: currentLang==='ja' ? 'HP +1 / ÂúßÂäõ +3' : 'HP +1 / Pressure +3',
                        desc: currentLang==='ja' ? 'ÂõûÂæ©„Åô„Çã„ÅåË≤†Ëç∑„Åå„Åã„Åã„Çã' : 'Heal yourself, but strain the system.',
                        apply(){ 
                            gameState.hp += 1; // ‰∏äÈôêÁ™ÅÁ†¥ (Fix)
                            gameState.pressure += 3; 
                        }
                    },
                    {
                        kicker: currentLang==='ja' ? 'Âπ≥Èùô' : 'Calm',
                        title: currentLang==='ja' ? 'ÂúßÂäõ -6' : 'Pressure -6',
                        desc: currentLang==='ja' ? 'ÂøÉ„ÇíËêΩ„Å°ÁùÄ„Åë„Çã' : 'Significantly reduce pressure.',
                        apply(){ gameState.pressure = Math.max(0, gameState.pressure-6); }
                    }
                ];
            }
            return [
                {
                    kicker: currentLang==='ja' ? 'ÊµÑÂåñ' : 'Purify',
                    title: currentLang==='ja' ? 'ÂúßÂäõ -2' : 'Pressure -2',
                    desc: currentLang==='ja' ? 'Â∞ë„ÅóËêΩ„Å°ÁùÄ„Åè' : 'Minor relief.',
                    apply(){ gameState.pressure = Math.max(0, gameState.pressure-2); }
                },
                {
                    kicker: currentLang==='ja' ? 'Ë≤™Ê¨≤' : 'Greed',
                    title: currentLang==='ja' ? '„Ç®„ÉÉ„Çª„É≥„Çπ +3 / ÂúßÂäõ +1' : 'Essence +3 / Pressure +1',
                    desc: currentLang==='ja' ? 'Â∞è„Åï„Å™‰ª£ÂÑü„ÅßÂØå„Çí' : 'Wealth at a cost.',
                    apply(){ gameState.essence += 3; gameState.pressure += 1; }
                }
            ];
        }

        function openPerkScreen(isDeath){
            perkScreen.classList.remove('hidden');

            ui('perk-title').textContent = isDeath ? t('gameOver') : t('victory');
            ui('perk-subtitle').textContent = isDeath ? t('gameOverSub') : t('victorySub');
            ui('perk-essence').textContent = `Essence: ${gameState.essence} ‚ú®`;

            // Reset contents
            perkCards.innerHTML = '';
            shopCards.innerHTML = '';
            
            if(isDeath){
                perkCards.innerHTML = `<div class="text-slate-500 text-sm">No mutations acquired.</div>`; 
                shopCards.innerHTML = `
                    <div class="col-span-full text-center py-10">
                        <p class="text-slate-400 mb-6 font-bold text-xl">Floor Reached: ${gameState.floor}</p>
                        <button onclick="startNewRun()" class="px-8 py-4 bg-rose-600 rounded-xl font-black text-white uppercase tracking-widest hover:bg-rose-500 shadow-lg shadow-rose-900/40 transform transition hover:-translate-y-1">Try Again</button>
                    </div>
                `;
                continueBtn.style.display = 'none';
                return;
            }

            continueBtn.style.display = 'block';
            continueBtn.textContent = t('continue');
            continueBtn.onclick = () => {
                perkScreen.classList.add('hidden');
                nextFloor();
            };

            if (!gameState.currentPerkChoices) {
                gameState.currentPerkChoices = rollPerkChoices();
            }
            gameState.currentPerkChoices.forEach(p => perkCards.appendChild(buildPerkCard(p)));
            
            ui('reroll-btn').classList.toggle('hidden', gameState.essence < 5);

            SHOP_ITEMS.forEach(item => shopCards.appendChild(buildShopCard(item)));
        }

        function rollPerkChoices(){
            const all = Object.values(PERKS);
            const candidates = all.filter(p => !gameState.perks.has(p.id));
            const pool = candidates.length >= 3 ? candidates : all;
            
            const picks = [];
            const safePool = [...pool];
            while(picks.length < 3 && safePool.length > 0){
                const idx = randInt(safePool.length);
                picks.push(safePool[idx]);
                safePool.splice(idx, 1);
            }
            return picks;
        }

        function buildPerkCard(perk){
            const card = document.createElement('div');
            card.className = `perk-card glass-panel p-3 cursor-pointer rarity-${perk.rarity} relative hover:bg-white/5 transition-all`;
            const name = currentLang==='ja' ? perk.name.ja : perk.name.en;
            const desc = currentLang==='ja' ? perk.desc.ja : perk.desc.en;
            const owned = gameState.perks.has(perk.id);
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[9px] text-slate-400 uppercase tracking-widest">${perk.rarity}</span>
                    ${owned ? '<span class="text-[9px] text-sky-400 font-bold uppercase">OWNED</span>' : ''}
                </div>
                <div class="text-sm font-black text-white leading-tight mb-1">${name}</div>
                <div class="text-slate-400 text-[10px] leading-relaxed">${desc}</div>
                ${!owned ? '<div class="absolute bottom-2 right-2 text-white/10 text-xl font-bold">+</div>' : ''}
            `;

            if(!owned){
                card.onclick = () => {
                    acquirePerk(perk.id);
                    // ÈÅ∏ÊäûÊ∏à„Åø„Ç®„Éï„Çß„ÇØ„Éà
                    Array.from(perkCards.children).forEach(c => {
                        c.style.pointerEvents = 'none';
                        c.style.opacity = '0.4';
                        c.classList.remove('border-sky-500');
                    });
                    card.style.opacity = '1';
                    card.style.borderColor = '#38bdf8';
                    card.classList.add('bg-sky-500/10');
                };
            } else {
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
            }
            return card;
        }

        function buildShopCard(item){
            const card = document.createElement('div');
            card.className = 'glass-panel p-3 flex flex-col justify-between relative group hover:border-white/20 transition-all';
            
            const def = item.type==='item' ? item.ref : item;
            
            const name = currentLang==='ja' ? def.name.ja : def.name.en;
            const desc = currentLang==='ja' ? def.desc.ja : def.desc.en;
            let cost = item.cost || def.cost;
            
            // Perk: Bargain
            if(gameState.perks.has('bargain')) cost = Math.floor(cost * 0.8);
            
            const canBuy = gameState.essence >= cost;
            
            let ownedText = '';
            if(item.type==='item' && def.type==='consumable'){
                 const count = gameState.inventory[def.id] || 0;
                 if(count > 0) ownedText = `x${count}`;
            }

            // Compact Shop Card Layout
            card.innerHTML = `
                <div>
                    <div class="flex items-start justify-between mb-1">
                        <div class="text-xs font-black text-white truncate pr-1">${name}</div>
                        <div class="text-sky-300 text-[10px] font-bold whitespace-nowrap">${cost}‚ú®</div>
                    </div>
                    <div class="text-slate-500 text-[9px] leading-tight h-8 overflow-hidden">${desc}</div>
                </div>
                <button class="mt-2 w-full py-1.5 bg-white/5 rounded font-bold text-[10px] uppercase tracking-widest transition-all ${canBuy ? 'hover:bg-sky-500 hover:text-white' : 'opacity-30 cursor-not-allowed'} flex items-center justify-center gap-1">
                    <span>BUY</span>
                    ${ownedText ? `<span class="bg-black/40 px-1 rounded text-white/70">${ownedText}</span>` : ''}
                </button>
            `;
            
            const btn = card.querySelector('button');
            if(canBuy){
                btn.onclick = () => {
                    if(item.type === 'item' && def.type==='tool' && gameState.inventory[def.id]){
                        // One time tool
                        return;
                    }
                
                    gameState.essence -= cost;
                    
                    if(item.type === 'item'){
                        const id = def.id;
                        if(!gameState.inventory[id]) gameState.inventory[id] = 0;
                        if(def.type === 'tool') gameState.inventory[id] = 1;
                        else gameState.inventory[id]++;
                        
                        showToast(currentLang==='ja'?`${name}„ÇíË≥ºÂÖ•ÔºÅ`:`Bought ${name}!`, 'sky');
                    } else {
                        item.apply(gameState);
                    }
                    
                    // Update Essence UI
                    ui('perk-essence').textContent = `Essence: ${gameState.essence} ‚ú®`;
                    ui('ui-essence').textContent = `${gameState.essence} ‚ú®`;
                    
                    // Re-render shop to update buttons/owned counts
                    shopCards.innerHTML = '';
                    SHOP_ITEMS.forEach(i => shopCards.appendChild(buildShopCard(i)));
                };
            }
            return card;
        }

        function acquirePerk(id){
            gameState.perks.add(id);
            if(id === 'unseal') gameState.unsealActive = true;
            if(id === 'reflux') gameState.refluxArmed = true;
            if(id === 'overflow') {
                gameState.pressureMax += 4;
                renderHUD(); 
            }
            renderHUD();
        }

        // --- Core Loop ---
        function startNewRun(){
            startScreen.classList.add('hidden');
            gameState.floor = 1;
            gameState.essence = 0;
            gameState.hp = 3;
            gameState.maxHp = 3;
            gameState.perks = new Set();
            gameState.pressure = 0;
            gameState.pressureMax = 14;
            gameState.history = [];
            gameState.inventory = {}; 
            gameState.unsealActive = false;
            gameState.refluxArmed = false;
            gameState.momentumActive = false;
            gameState.currentPerkChoices = null; 
            gameState.pipetteMode = false;
            gameState.targetMode = null;
            
            perkScreen.classList.add('hidden'); 
            nextFloor(true);
        }

        function nextFloor(isFirst=false){
            if(!isFirst) gameState.floor += 1;
            
            // --- Capacity Progression Logic ---
            // Floor 1-3: Cap 4
            // Floor 4-7: Cap 5
            // Floor 8+: Cap 6 (Max)
            if (gameState.floor >= 8) gameState.capacity = 6;
            else if (gameState.floor >= 4) gameState.capacity = 5;
            else gameState.capacity = 4;
            
            // Perk: Scavenger logic
            if(!isFirst && gameState.perks.has('scavenger')){
                if(Math.random() < 0.15){
                    const items = ['inverter', 'void_salt', 'separator', 'cycle_siphon']; 
                    const gift = pick(items);
                    if(!gameState.inventory[gift]) gameState.inventory[gift] = 0;
                    gameState.inventory[gift]++;
                    // alert("Scavenger found: " + ITEMS[gift].name[currentLang==='ja'?'ja':'en']);
                    showToast("Scavenger found: " + ITEMS[gift].name[currentLang==='ja'?'ja':'en'], 'emerald');
                }
            }
            
            // Perk: Transmutation Logic (NEW)
            if(!isFirst && gameState.perks.has('transmutation')){
                const items = ['inverter', 'void_salt', 'separator', 'cycle_siphon']; 
                const gift = pick(items);
                if(!gameState.inventory[gift]) gameState.inventory[gift] = 0;
                gameState.inventory[gift]++;
                showToast("Transmutation: Created " + ITEMS[gift].name[currentLang==='ja'?'ja':'en'], 'purple');
            }
            
            // Perk: Deep Adapt Logic
            if(gameState.perks.has('deep_adapt')){
                // Gain +1 Max HP if capacity > 4
                if(gameState.capacity > 4){
                    gameState.maxHp += 1;
                    gameState.hp += 1; // Heal as well?
                }
            }

            gameState.movesPerFloor = 0; // Unused
            gameState.turnCount = 0;
            gameState.pressure = 0; 
            gameState.catalystAvailable = true;
            if(gameState.perks.has('reflux')) gameState.refluxArmed = true;

            generateBoard();
            generateGoals();
            
            gameState.currentPerkChoices = null;
            gameState.selectedIdx = null;
            gameState.busy = false;
            gameState.targetMode = null;
            gameState.pipetteMode = false;
            gameState.momentumActive = false;
            
            renderHUD();
            renderBoard();
        }

        function tryUndo(){
            if (!gameState.history.length) return;
            
            let cost = 5; 
            let isFree = false;
            
            if(gameState.refluxArmed){
                isFree = true;
            } else if (gameState.essence < cost){
                ui('ui-essence').classList.add('text-red-500');
                setTimeout(()=>ui('ui-essence').classList.remove('text-red-500'), 500);
                return;
            }

            const prev = gameState.history.pop();
            gameState.tubes = prev.tubes;
            gameState.turnCount = prev.turnCount;
            gameState.pressure = prev.pressure;
            gameState.hp = prev.hp;
            gameState.secondaryProgress = prev.secondaryProgress;
            gameState.catalystAvailable = prev.catalystAvailable;
            gameState.essence = prev.essence;
            gameState.inventory = prev.inventory; 
            gameState.tubeCount = prev.tubeCount;
            gameState.capacity = prev.capacity || 4; // Restore capacity
            gameState.momentumActive = prev.momentumActive;
            
            if(isFree){
                gameState.pressure += 2;
                gameState.refluxArmed = false;
                showFloatText(0, "Reflux Used (+2 Pressure)", "#a855f7");
            } else {
                gameState.essence -= cost;
            }

            gameState.selectedIdx = null;
            updateTubeLayout();
            renderHUD();
            renderBoard();
        }

        // --- HUD ---
        function renderHUD(){
            setText('ui-floor', `${t('floor')} ${gameState.floor}`);
            setText('ui-essence', `${gameState.essence} ‚ú®`);
            setText('ui-hp', `HP ${gameState.hp}`);
            
            setText('ui-essence-mobile', `${gameState.essence} ‚ú®`);
            setText('ui-hp-mobile', `HP ${gameState.hp}`);

            setText('ui-turn', `${t('turn')} ${gameState.turnCount}`);
            setText('ui-perks', `${t('perks')} ${gameState.perks.size}`);

            setText('ui-goal', gameState.primaryGoal?.text ?? '‚Äî');
            setText('ui-goal-sub', gameState.secondaryGoal?.text ?? '‚Äî');
            
            setText('ui-secondary', `${t('secondary')} ${secondarySucceeded() ? 'COMPLETE' : '‚Äî'}`);
            
            const secondaryEl = ui('ui-secondary');
            if (secondaryEl) {
                secondaryEl.className = secondarySucceeded() 
                    ? "px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest bg-emerald-500/20 text-emerald-300 border border-emerald-500/50"
                    : "px-4 py-2 rounded-xl glass-panel text-lg font-black uppercase tracking-widest bg-black/20";
            }

            setText('ui-pressure', String(gameState.pressure));
            const pct = Math.round((gameState.pressure / gameState.pressureMax) * 100);
            
            const pBar = ui('ui-pressure-bar');
            if(pBar) {
                pBar.style.width = `${clamp(pct,0,100)}%`;
                 if(gameState.pressure >= gameState.pressureMax - 3){
                    pBar.classList.remove('from-sky-400', 'via-purple-400');
                    pBar.classList.add('bg-rose-600');
                } else {
                    pBar.classList.add('from-sky-400', 'via-purple-400');
                    pBar.classList.remove('bg-rose-600');
                }
            }
            setText('ui-pressure-sub', `${gameState.pressure} / ${gameState.pressureMax}`);
           
            
            // Undo„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
            const undoCost = gameState.refluxArmed ? 'FREE' : '5‚ú®';
            if (undoBtn) {
                undoBtn.innerHTML = `<span>‚Ü∫</span> UNDO (${undoCost})`;
                if(!gameState.refluxArmed && gameState.essence < 5 && gameState.history.length > 0){
                    undoBtn.style.opacity = '0.5';
                    undoBtn.style.cursor = 'not-allowed';
                } else if (gameState.history.length === 0){
                    undoBtn.style.opacity = '0.3';
                    undoBtn.style.cursor = 'default';
                } else {
                    undoBtn.style.opacity = '1';
                    undoBtn.style.cursor = 'pointer';
                }
            }

            renderSkills();
        }

        function moveFocus(dx){
            if(!gameState.tubes.length) return;
            const n = gameState.tubeCount;
            
            // „Ç≠„ÉºÊìç‰ΩúÊôÇ„Å´„Éï„Ç©„Éº„Ç´„Çπ„Åå„Å™„Åë„Çå„Å∞0Áï™ÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶Ë°®Á§∫ÈñãÂßã
            if (gameState.focusIdx === null) {
                gameState.focusIdx = 0;
            } else {
                gameState.focusIdx = (gameState.focusIdx + dx + n) % n;
            }
            renderBoard();
        }

        ui('btn-help').onclick = () => ui('help-screen').classList.replace('hidden', 'flex');
        ui('help-close').onclick = () => ui('help-screen').classList.replace('flex', 'hidden');
        ui('btn-settings').onclick = () => ui('settings-screen').classList.replace('hidden', 'flex');
        ui('settings-close').onclick = () => ui('settings-screen').classList.replace('flex', 'hidden');
        if(undoBtn) undoBtn.onclick = () => tryUndo();
        
        ui('reroll-btn').onclick = () => {
            if(gameState.essence >= 5){
                gameState.essence -= 5;
                gameState.currentPerkChoices = null; 
                openPerkScreen(false); 
                ui('perk-essence').textContent = `Essence: ${gameState.essence} ‚ú®`;
            }
        };

        ui('toggle-tests').onchange = (e) => {
            devTests.style.display = e.target.checked ? 'block' : 'none';
        };
        
        ui('start-run-btn').onclick = startNewRun;

        window.onkeydown = (e) => {
            if(!perkScreen.classList.contains('hidden')) return;
            if(!eventScreen.classList.contains('hidden')) return;
            if(!helpScreen.classList.contains('hidden')) return;

            if (e.key === 'ArrowLeft') moveFocus(-1);
            if (e.key === 'ArrowRight') moveFocus(1);
            
            if (e.key === 'Enter' || e.key === ' ') {
                 if(gameState.focusIdx !== null) handleTubeClick(gameState.focusIdx);
            }
            if (e.key === 'Backspace' || e.key === 'z') tryUndo();
        };

        applyLang();
        
    </script>
</body>
</html>